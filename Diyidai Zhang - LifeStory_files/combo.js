function newFactEditModal(persondata,assertionId,hasLifeStoryOptions,tabActivate,contentActivate,addPersonNewPID,saveEventData,isFromCreateEvent){var saveEventDataObj,pid,url;if(typeof persondata=="undefined"){alert("persondata cannot be null");return}var isValidNewAddPersonId=typeof addPersonNewPID!="undefined"&&addPersonNewPID!=null&&addPersonNewPID.length>0,dateFieldVal="",placeFieldVal="",descriptionFieldVal="",isPrimary=!1,eventType="",newPersonPid="";window.PersonData=persondata;PersonData.hasAddedNewSpouse=!1;PersonData.newAddedSpouseId="";isValidNewAddPersonId&&(newPersonPid=addPersonNewPID,PersonData.hasAddedNewSpouse=!0,PersonData.newAddedSpouseId=addPersonNewPID,typeof saveEventData!="undefined"&&saveEventData.length>0&&(saveEventDataObj=jQuery.parseJSON(saveEventData),eventType=saveEventDataObj.eventType,dateFieldVal=saveEventDataObj.dateField,placeFieldVal=saveEventDataObj.placeField,descriptionFieldVal=saveEventDataObj.descriptionField,isPrimary=!1,saveEventDataObj.isAddNewSpouse==="true"&&($(".editModalSaveButton").unbind("click"),ResetWarningsAndValues(),FactEditModal.isAddNewSpouse=!0)));pid=typeof PersonData.personId!="object"?PersonData.personId:PersonData.personId.value;url="/modals/factedit/tree/"+PersonData.treeId+"/person/"+pid+"/assertionid/"+assertionId;$("<div>").modal({showLoading:!0,useCustomPadding:!0,onOpen:function($this){$.ajax({type:"GET",url:url,cache:!1,timeout:2e4,data:{hasLifeStoryOptions:hasLifeStoryOptions,newPersonPid:newPersonPid},success:function(data){var spouseCount,dateField,placeField,descriptionField,$indvSpouseSelect,$sortingDivTopAlert,$sortingDivBottomAlert,locationField,openTab,modalHeader,cancelClose,factItem,modalEditEvent,selectedPerson,preferredStored,preferredEventStored,individualSpouseSelect,multipleSpouseSelect,displayLifeStory,displayLifeStoryVal;if(data.result){if($.modal.showLoading(!1),$.modal.resize(760),$this.html(data.html),$("#modal").find(".alertNote").alert(personViewModalAlertSettingsNote).end().find(".alertInfo").alert(personViewModalAlertSettingsInfo).end().find(".alertSuccess").alert(personViewModalAlertSettingsSuccess).end().find(".alert:not(.alertNote):not(.alertInfo):not(.alertSuccess)").alert(personViewModalAlertSettingsWarning),sortingCardOutlineHover(),!isValidNewAddPersonId&&isRelationshipEventType()&&$(".editModalSaveButton").unbind("click"),spouseCount=parseInt(FactEditModal.person.spouseCount),isValidNewAddPersonId&&(dateField=$(".dateField"),dateField.length>0&&dateField.val(dateFieldVal),placeField=$(".placeField"),placeField.length>0&&placeField.val(placeFieldVal),descriptionField=$(".descriptionField"),descriptionField.length>0&&descriptionField.val(descriptionFieldVal),$("#individualSpouseSelect").show(),$("#selectedSpouse-individual").removeClass("selectedPerson"),$indvSpouseSelect=$(".existingSpouseIndividual"),$indvSpouseSelect.length>0&&$indvSpouseSelect.addClass("selectedPerson"),$("#multipleSpouseSelect").hide(),spouseCount>1?($("#changeSpouseButton").show().attr("onClick","showMultipleSpouseSelect();"),$("#chooseOtherButton").hide()):($("#changeSpouseButton").hide(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();")),FactEditModal.warningMessage="",FactEditModal.hasValidationWarningToSelectSpouse=!1,FactEditModal.isAddNewSpouse=!1),typeof FactEditModal!="undefined"&&$(".modalEditEvent .iconRotateRight").callout({position:"left",type:"click",classes:"calloutGenerateNarrative",content:"#generateNarrativeCalloutDomContent",onAfterOpen:function(){$("#callout").attr("onClick",".closeCallouts",function(){closeCallouts()})},style:"dark"}),$(".modalEditEvent .removeButton").callout({position:"top",style:"dark",type:"click",classes:"calloutRemoveEvent",content:"#removeEventCalloutDomContent",onAfterOpen:function(){$("#callout").attr("onClick",".closeCallouts",function(){closeCallouts()})}}),sortingCardOutlineHover(),$sortingDivTopAlert=$("#source_sortingDivTop .alert"),$sortingDivBottomAlert=$("#source_sortingDivBottom .alert"),$sortingDivTopAlert.alert(personViewModalAlertSettingsNote),$sortingDivBottomAlert.alert(personViewModalAlertSettingsNote),$.cachedScript(PersonData.animateCardUrl).done(function(){$("#source_sortingDivBottom").animateCard({items:".card",animateMove:{afterAnimate:function(item){item.find(".sortingIcon").hasClass("iconAdd")?(item.removeClass("cardOutline2").addClass("attached"),PersonData.hasEditRights&&item.find(".sortingIcon").removeClass("iconAdd noHover").addClass("iconClose")):(item.removeClass("cardOutline2").removeClass("attached"),PersonData.hasEditRights&&item.find(".sortingIcon").removeClass("iconClose noHover").addClass("iconAdd"))},beforeAnimate:function(item){item.find(".card").addClass("cardOutline2")},connectWith:"#source_sortingDivTop",emptyContent:".alertNote"},onListEmpty:function(emptyList){emptyList.find(".alertNote").alert("open")},onEmptyListAdd:function(list){list.find(".alertNote").alert("close")}})}),$("#source_sortingDivTop .card").length===0&&$sortingDivTopAlert.alert("open"),$("#source_sortingDivBottom .card").length===0&&$sortingDivBottomAlert.alert("open"),locationField=$("#location"),locationField.length>0&&factModalInitTypeAhead(PersonData.treeId,locationField),openTab=0,typeof PersonData.openOnLoadTab!="undefined"&&(openTab=parseInt(PersonData.openOnLoadTab)),PersonData.openOnLoadTab=0,(FactEditModal.isAddNewFact||typeof isFromCreateEvent!="undefined"&&isFromCreateEvent)&&(typeof tabActivate!="undefined"&&tabActivate!=null&&tabActivate.length>0&&typeof contentActivate!="undefined"&&contentActivate!=null&&contentActivate.length>0?(modalHeader=$("#modalHeader"),modalHeader.length>0&&modalHeader.remove(),tabActivate!=="factEditModalEvent"&&tabActivate!=="editModalSaveButton"&&($("#factEditModalEvent").removeClass("tabActive active"),$(".tabContent1").removeClass("tabActive active")),$("#"+tabActivate).hasClass("tabActive active")||$("#"+tabActivate).addClass("tabActive active"),contentActivate!=="tabContent1"&&$(".tabContent1").removeClass("tabActive active"),$("."+contentActivate).hasClass("tabActive active")||$("."+contentActivate).addClass("tabActive active"),openTab=contentActivate==="tabContent2"?1:contentActivate==="tabContent3"?2:0,PersonData.openOnLoadTab=openTab,cancelClose=$(".cancelClose"),cancelClose.length>0&&cancelClose.text(FactEditModal.text.close),setFactModalTabsClick(!FactEditModal.hasValidationError,null,!0)):($("#factEditModalEvent").addClass("tabActive active"),$(".tabContent1").addClass("tabActive active"))),$("#modalContainer .tabs").tabs({activeIndex:openTab,onOpen:!1}),modalButtonClick(),setupFactModalUserCard(),factItem=$("#fi"+assertionId),modalEditEvent=$(".tabContent1"),modalEditEvent.length>0&&openTab===0)if(selectedPerson=modalEditEvent.find(".selectedPerson"),isRelationshipEventType()&&selectedPerson.length===0&&(selectedPerson=modalEditEvent.find(".selectedPerson")),!isValidNewAddPersonId&&isRelationshipEventType()&&FactEditModal.originalSpouseId.length===0&&selectedPerson.length>0&&resetIndividualSpouseNode(selectedPerson,0),(FactEditModal.eventType.toLowerCase()==="birth"||FactEditModal.eventType.toLowerCase()==="death"||FactEditModal.eventType.toLowerCase()==="name")&&(factItem.hasClass("preferredEvent"+FactEditModal.eventType)?(modalEditEvent.find(".isPrimaryCheckbox").attr("checked",!0),modalEditEvent.find(".isPrimaryCheckbox").attr("data-original-isprimary","true"),$("#preferredEventButtonLabel").show(),FactEditModal.eventType.toLowerCase()!=="name"&&$("#factEditModalTimelineOptions").css("display","")):($("#preferredEventCheckbox").show(),modalEditEvent.find(".isPrimaryCheckbox").attr("checked",!1))),retrieveStoredFactValues(factItem,".givenNameStored"+assertionId,modalEditEvent,"#givenName"),retrieveStoredFactValues(factItem,".surnameStored"+assertionId,modalEditEvent,"#surname"),retrieveStoredFactValues(factItem,".suffixStored"+assertionId,modalEditEvent,"#suffix"),preferredStored=factItem.find(".preferredStored"+assertionId),preferredStored.length>0&&(preferredStored.val()==="true"&&factItem.hasClass("preferredEvent"+FactEditModal.eventType)?modalEditEvent.find(".isPrimaryCheckbox").attr("checked",!0):modalEditEvent.find(".isPrimaryCheckbox").attr("checked",!1)),retrieveStoredFactValues(factItem,".dateStored"+assertionId,modalEditEvent,"#date"),retrieveStoredFactValues(factItem,".placeStored"+assertionId,modalEditEvent,"#location"),retrieveStoredFactValues(factItem,".descriptionStored"+assertionId,modalEditEvent,"#description"),preferredEventStored=factItem.find(".preferredEventStored"+assertionId),preferredEventStored.length>0&&(preferredEventStored.val()==="true"&&factItem.hasClass("preferredEvent"+FactEditModal.eventType)?modalEditEvent.find(".isPrimaryCheckbox").attr("checked",!0):modalEditEvent.find(".isPrimaryCheckbox").attr("checked",!1)),individualSpouseSelect=modalEditEvent.find("#individualSpouseSelect"),isRelationshipEventType()&&(typeof newPersonPid=="undefined"||typeof newPersonPid!="undefined"&&newPersonPid.length===0)&&FactEditModal.originalSpouseId.length===0)selectedPerson.length>0&&resetIndividualSpouseNode(selectedPerson,0),modalEditEvent.find(".eventAreaBannerWarning").alert("close"),ResetWarningsAndValues(),multipleSpouseSelect=modalEditEvent.find("#multipleSpouseSelect"),spouseCount===1?(individualSpouseSelect.hide(),multipleSpouseSelect.show(),$("#singleScenarioSpouseSelect").show(),$("#noSpouseForEventSingle").hide(),$("#noSpouseForEventMulti").hide(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();")):spouseCount>1?(individualSpouseSelect.hide(),$("#spouseText").hide(),$("#selectSpouseForEventText").show(),multipleSpouseSelect.show(),$("#noSpouseForEventSingle").hide(),$("#noSpouseForEventMulti").hide(),$("#chooseOtherButton").show().attrn("onClick","showSpouseTypeAheadSection();")):($("#chooseOtherButton").hide(),$(".addRelationships").show(),showSpouseTypeAheadSection(),$(".erAddCancel").hide()),setEditModalSaveButtonClick();else if(isRelationshipEventType()&&typeof newPersonPid!="undefined"&&newPersonPid.length>0){if(spouseCount===1&&setIndividualSpouseData(modalEditEvent,".singleScenarioSpouseSelect"),!showIndividualSpouse())return;individualSpouseSelect=$(".existingSpouseIndividual");individualSpouseSelect.length>0&&individualSpouseSelect.addClass("selectedPerson");(spouseCount===0||spouseCount===1)&&($("#changeSpouseButton").hide(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();"));setEditModalSaveButtonClick()}$(".tabContent4").find(".narrativeDataFields").hide();displayLifeStory=$(".tabContent4").find(".displayLifestory");displayLifeStory.length>0&&(displayLifeStoryVal=displayLifeStory.prop("checked"),displayLifeStory.data("original-displaylifestory",displayLifeStoryVal.toString()));FactEditModal.eventType==="Gender"?($(".editModalSaveButton").removeAttr("disabled"),setFactModalTabsClick(!FactEditModal.hasValidationError)):FactEditModal.eventType==="Name"?(modalEditEvent.find(".eventAreaBannerWarning").alert("close"),setFactModalTabsClick(!FactEditModal.hasValidationError)):typeof tabActivate!="undefined"&&tabActivate!=null&&tabActivate.length>0&&typeof contentActivate!="undefined"&&contentActivate!=null&&contentActivate.length>0||setButtonandBannerBasedOnValidation(!1);setButtonBasedOnValidation()}$("#modalClose").length===0&&$("#modalContents").prepend('<button type="button" title="Close modal" id="modalClose" class="closeBtn"><\/button>')},error:function(ex){typeof ex!="undefined"&&typeof ex.statusText!="undefined"&&($.modal.showLoading(!1),$("<div><p>"+PersonCard.text.addPersonErrorText+"<\/p><\/div>").modal({title:""}),window.console&&window.console.log(ex.statusText))}})},onClose:function(){$(".factItemSelected").focus()}})}function sortingCardOutlineHover(){$(".sortingCard").on("click",".sortingIcon",function(){$(this).addClass("noHover")}).on("mouseenter",".sortingIcon:not(.noHover)",function(){$(this).closest(".card").addClass("cardOutline2")}).on("mouseleave",".sortingIcon:not(.noHover)",function(){$(this).closest(".card").removeClass("cardOutline2")})}function isRelationshipEventType(){return typeof FactEditModal.isRelationshipType=="undefined"&&(FactEditModal.isRelationshipType=FactEditModal.eventType==="Marriage"||FactEditModal.eventType==="MarriageBann"||FactEditModal.eventType==="MarriageContract"||FactEditModal.eventType==="MarriageLicense"||FactEditModal.eventType==="MarriageSettlement"||FactEditModal.eventType==="Annulment"||FactEditModal.eventType==="Divorce"||FactEditModal.eventType==="DivorceFiled"||FactEditModal.eventType==="Engagement"||FactEditModal.eventType==="SealSpouseLDS"||FactEditModal.eventType==="NumMarriages"||FactEditModal.eventType==="Separation"),FactEditModal.isRelationshipType}function factModalInitTypeAhead(treeId,locationField){locationField.autocomplete({source:"/suggest/place?treeId="+treeId+"&tad=none",key:"placeName",queryParameter:"term",dataType:"json",minLength:3,maxResults:12,customDisplay:function(data){return{value:data.value,display:data.display}},onItemSelect:function(itemData){var $this,$card;itemData!==""&&($this=$(this),itemData.PID!=""&&($card=$this.closest(".card"),$card.find(".erAddExistingData").data("itemData",itemData),$card.find(".erAddSave").prop("disabled",!1)))},onOpen:!1,onClose:!1})}function setupFactModalUserCard(){var factTitlePersonCard=$(".factTitlePersonCard");if(factTitlePersonCard.length>0){var userCardImgSquare=factTitlePersonCard.find(".userCardImgSquare"),userCardTitle=factTitlePersonCard.find(".userCardTitle"),userCardSubTitle=factTitlePersonCard.find(".userCardSubTitle");userCardTitle.length>0&&userCardSubTitle.length>0&&(userCardImgSquare.addClass("icon"+PersonCard.gender),userCardTitle.html(PersonCard.name),PersonCard.lifeYearRange.length>1&&PersonCard.lifeYearRange!=="&ndash;"?userCardSubTitle.text("("+PersonCard.lifeYearRange.replace("&ndash;","-")+")"):userCardSubTitle.text(""),factTitlePersonCard.show())}}function retrieveStoredFactValues(factItem,storedAccessor,modalArea,fieldId){var storedValue=factItem.find(storedAccessor);storedValue.length>0&&modalArea.find(fieldId).val(storedValue.val())}function setButtonandBannerBasedOnValidation(showBanner){var modalEditEvent=$(".tabContent1"),bannerObj=modalEditEvent.find(".eventAreaBannerWarning");checkFieldValidation(!1,showBanner,[]);showBanner&&(FactEditModal.hasValidationWarning||FactEditModal.hasValidationDateWarning||FactEditModal.hasValidationError||FactEditModal.hasValidationWarningToSelectSpouse?displayBannerObjWarning(bannerObj):clearAllBanners());setButtonBasedOnValidation();setupCorrectClickActionLinks()}function displayBannerObjWarning(bannerObj){typeof bannerObj!="undefined"&&bannerObj.length>0&&setTimeout(function(){var validationMessage="";FactEditModal.hasValidationError?typeof FactEditModal.validationErrorMessage!="undefined"&&FactEditModal.validationErrorMessage.length>0&&(validationMessage=FactEditModal.validationErrorMessage):FactEditModal.hasValidationWarning||FactEditModal.hasValidationDateWarning?(typeof FactEditModal.validationWarningMessage!="undefined"&&FactEditModal.validationWarningMessage.length>0&&(validationMessage=FactEditModal.validationWarningMessage),isRelationshipEventType()&&FactEditModal.hasValidationWarningToSelectSpouse?validationMessage=validationMessage.length>0?validationMessage+"  "+FactEditModal.text.warnToSelectSpouse:FactEditModal.text.warnToSelectSpouse:isDatePlaceEventType()&&(validationMessage=FactEditModal.hasValidationDateWarning?validationMessage.length>0?validationMessage+"  "+FactEditModal.text.warnStillUseItDate:FactEditModal.text.warnStillUseItDate:validationMessage.length>0?validationMessage+"  "+FactEditModal.text.warnStillUseIt:FactEditModal.text.warnStillUseIt)):isRelationshipEventType()&&FactEditModal.hasValidationWarningToSelectSpouse&&(validationMessage=validationMessage.length>0?validationMessage+"  "+FactEditModal.text.warnToSelectSpouse:FactEditModal.text.warnToSelectSpouse);validationMessage=FactEditModal.isAddNewFact?validationMessage.replace("{createAnywayOrSaveAnyway}",FactEditModal.text.addAnyway):validationMessage.replace("{createAnywayOrSaveAnyway}",FactEditModal.text.saveAnyway);validationMessage.length>0&&(bannerObj.text(validationMessage),bannerObj.alert("open"),$.modal.center())},500)}function checkFieldValidation(checkChanged,showBanner,dictionary){var modalEditEvent=$(".tabContent1"),selectedPerson=modalEditEvent.find(".selectedPerson"),requiredFields=0,emptyRequiredFields=0,fields=0,emptyFields=0,changed=!1,$checkBox,sid;return modalEditEvent.find(".factField").each(function(){var $field=$(this),fState=$field.data("state"),val=$field.val(),originalValue,currentValue,extra;$field.hasClass("requiredField")?requiredFields++:fields++;$field.attr("name")!=="gender"&&(val?(fState=="0"&&(fState=validateField($field.get(0))),fState=="4"||fState=="3"?showBanner&&(FactEditModal.validationWarningMessage=FactEditModal.validationWarningMessage.length===0?$field.data("msg"):FactEditModal.validationWarningMessage+" "+$field.data("msg"),fState=="3"?FactEditModal.hasValidationDateWarning=!0:fState=="4"&&(FactEditModal.hasValidationWarning=!0)):fState=="2"||fState=="1"):$field.hasClass("requiredField")?emptyRequiredFields++:emptyFields++);checkChanged&&($field.attr("name")!=="gender"||$field.is(":checked"))&&(originalValue=typeof $field.data("original-value")!="undefined"?$field.data("original-value"):"",currentValue=$field.val(),originalValue!=currentValue&&(changed=!0),extra=typeof $field.data("extra")!="undefined"?$field.data("extra"):"",dictionary[$field.attr("id")]={value:currentValue,origValue:originalValue,extra:extra})}),checkChanged&&($checkBox=modalEditEvent.find(".isPrimaryCheckbox"),$checkBox.length>0&&$checkBox.is(":checked")&&$checkBox.data("original-isprimary")==!1&&(changed=!0)),isRelationshipEventType()&&(typeof selectedPerson=="undefined"||selectedPerson.length===0?checkChanged&&!FactEditModal.isAddNewFact&&typeof FactEditModal.originalSpouseId!="undefined"&&FactEditModal.originalSpouseId.length>0?changed=!0:showBanner&&(FactEditModal.hasValidationWarningToSelectSpouse=!0):checkChanged&&(typeof FactEditModal.originalSpouseId=="undefined"||FactEditModal.originalSpouseId.length===0?changed=!0:(sid=selectedPerson.data("assertionid"),FactEditModal.originalSpouseId!=sid&&(changed=!0)))),(emptyRequiredFields>0||fields===emptyFields)&&(showBanner&&PersonData.hasEditRights&&(FactEditModal.validationErrorMessage=getWarningMessage(requiredFields>0&&requiredFields===emptyRequiredFields,fields===emptyFields)),FactEditModal.hasValidationError=!0,changed=!1),changed}function clearAllBanners(){$(".tabContent").find(".alert:not(.alertNote)").each(function(){var $this=$(this);$this.hasClass("alertHidden")||$this.alert("close")})}function setButtonBasedOnValidation(){!FactEditModal.hasValidationError&&(FactEditModal.hasValidationWarning||FactEditModal.hasValidationDateWarning||FactEditModal.hasValidationWarningToSelectSpouse)?(setupCreateOrSaveAnywayTextButton(),$(".editModalSaveButton").removeAttr("disabled")):(setupCreateOrSaveTextButton(),FactEditModal.hasValidationError?$(".editModalSaveButton").attr("disabled","disabled"):$(".editModalSaveButton").removeAttr("disabled"))}function setupCreateOrSaveTextButton(){FactEditModal.isAddNewFact?$(".editModalSaveButton").text(FactEditModal.text.create):$(".editModalSaveButton").text(FactEditModal.text.saveChanges)}function setupCorrectClickActionLinks(){var modalEditEvent=$(".tabContent1"),selectedPerson=modalEditEvent.find(".selectedPerson");FactEditModal.isAddNewFact?setAddNewFactCreateAction():PersonData.hasAddedNewSpouse&&PersonData.newAddedSpouseId.length>0?setFactModalTabsClick(!FactEditModal.hasValidationError,PersonData.newAddedSpouseId):isRelationshipEventType()&&(typeof selectedPerson=="undefined"||typeof selectedPerson!="undefined"&&selectedPerson.length===0)?setFactActionWithValidate():setFactModalTabsClick(!FactEditModal.hasValidationError)}function setFactModalTabsClick(valid,newPidVal,showBanner){var newPid,clearBanners,showBannerVal,jss;valid&&(typeof FactEditModal.buttonsBound!="undefined"&&FactEditModal.buttonsBound||(newPid="",typeof newPidVal!="undefined"&&newPidVal!=null&&newPidVal.length>0&&(newPid=newPidVal),clearBanners=typeof showBanner!="undefined"&&showBanner?"false":"true",showBannerVal=typeof showBanner!="undefined"&&showBanner?"true":"false",$(".editModalSaveButton").attr("onClick","factEditModalHandleTabClick('editModalSaveButton', '"+newPid+"', "+clearBanners+", "+showBannerVal+", true);"),$("#factEditModalEvent").attr("onClick","factEditModalHandleTabClick('factEditModalEvent', '"+newPid+"', "+clearBanners+", "+showBannerVal+", true);"),$("#factEditModalAttachMedia").attr("onClick","factEditModalHandleTabClick('factEditModalAttachMedia', '"+newPid+"', "+clearBanners+", "+showBannerVal+", true);"),$("#factEditModalSourceCitations").attr("onClick","factEditModalHandleTabClick('factEditModalSourceCitations', '"+newPid+"', "+clearBanners+", "+showBannerVal+", true);"),$("#factEditModalTimelineOptions").attr("onClick","factEditModalHandleTabClick('factEditModalTimelineOptions', '"+newPid+"', "+clearBanners+", "+showBannerVal+", true);"),jss="javascript:spouseClickHandler('"+FactEditModal.person.spouseCount+"', '"+FactEditModal.assertionId+"', '"+newPid+"', '');",FactEditModal.person.spouseCount==="1"?$(".chooseOtherButton").attr("onClick",jss):$(".changeSpouseButton").attr("onClick",jss),FactEditModal.buttonsBound=!0))}function spouseClickHandler(count){count==="1"?showSpouseTypeAheadSection():showMultipleSpouseSelect()}function unsetFactModalTabsClick(){}function savePersonNarrativeAndEventDataModal(assertionid,newRelationshipPid,saveEventData,isSpouseDataValidate,clearBanners){var descriptionField,genderTypeField,originalIsPrimary,saveValue,url;typeof clearBanners!="undefined"&&clearBanners&&clearAllBanners();var modalEditEvent=$(".tabContent1"),modalNarrative=$(".tabContent4"),modalEditEventActive=modalEditEvent.hasClass("tabActive"),modalNarrativeActive=modalNarrative.hasClass("tabActive"),selectedPerson=modalEditEvent.find(".selectedPerson"),isCreateRelationshipEvent=!1,eventType=FactEditModal.eventType,isPrimary=modalEditEvent.find(".isPrimaryCheckbox").prop("checked"),saveEventDataObj="",placeField="",placeFieldDataExtra="",dictionary=[],eventChanged=modalEditEventActive?checkFieldValidation(!0,!1,dictionary):!1,narrativeChanged=!1,placeGpid=null,titleField=typeof dictionary.title!="undefined"?dictionary.title.value:"",dateField=typeof dictionary.date!="undefined"?dictionary.date.value:"";typeof dictionary.location!="undefined"&&(placeField=dictionary.location.value,placeFieldDataExtra=dictionary.location.extra);descriptionField=typeof dictionary.description!="undefined"?dictionary.description.value:"";genderTypeField=typeof dictionary.genderMale!="undefined"?"Male":typeof dictionary.genderFemale!="undefined"?"Female":"Unknown";typeof placeFieldDataExtra!="undefined"&&placeFieldDataExtra.length>0&&$.each($.parseJSON(placeFieldDataExtra),function(key,value){key==="GPID"&&(placeGpid=value)});var valueField=typeof dictionary.value!="undefined"?dictionary.value.value:"",givenNameField=typeof dictionary.givenName!="undefined"?dictionary.givenName.value:"",surnameField=typeof dictionary.surname!="undefined"?dictionary.surname.value:"",suffixNameField=typeof dictionary.suffix!="undefined"?dictionary.suffix.value:"";if(typeof newRelationshipPid!="undefined"&&newRelationshipPid.length>0&&(isCreateRelationshipEvent=!0,typeof saveEventData!="undefined"&&saveEventData.length>0&&(saveEventDataObj=jQuery.parseJSON(saveEventData),eventType=saveEventDataObj.eventType,dateField=saveEventDataObj.dateField,placeField=saveEventDataObj.placeField,descriptionField=saveEventDataObj.descriptionField,isPrimary=!1)),originalIsPrimary=modalEditEvent.find(".isPrimaryCheckbox").attr("data-original-isprimary"),modalNarrativeActive){var lifestoryTitleField=modalNarrative.find(".lifestoryTitleField").val(),originalLifestoryTitleVal=modalNarrative.find(".lifestoryTitleField").attr("data-original-lifestorytitle"),narrativeField=modalNarrative.find(".narrativeField").val(),originalNarrativeVal=modalNarrative.find(".narrativeField").attr("data-original-narrative"),displayOnLifeStory=modalNarrative.find("#displayLifestory").prop("checked"),originalDisplayOnLifeStory=modalNarrative.find("#displayLifestory").attr("data-original-displaylifestory");(typeof originalLifestoryTitleVal!="undefined"&&typeof lifestoryTitleField!="undefined"&&originalLifestoryTitleVal!==lifestoryTitleField||typeof originalNarrativeVal!="undefined"&&typeof narrativeField!="undefined"&&originalNarrativeVal!==narrativeField||typeof originalDisplayOnLifeStory!="undefined"&&typeof displayOnLifeStory!="undefined"&&originalDisplayOnLifeStory!==displayOnLifeStory.toString())&&(narrativeChanged=!0)}var relationshipEventType=isRelationshipEventType(),relationshipId=typeof newRelationshipPid!="undefined"&&newRelationshipPid.length>0?newRelationshipPid:typeof selectedPerson!="undefined"&&selectedPerson.length>0&&typeof selectedPerson.attr("data-assertionId")!="undefined"&&selectedPerson.attr("data-assertionId").length>0?selectedPerson.attr("data-assertionId"):"",relTypeAheadVal="false";if(relationshipEventType&&relationshipId!=null&&relationshipId!==""&&FactEditModal.originalSpouseId!==relationshipId?(eventChanged=!0,relTypeAheadVal=typeof selectedPerson!="undefined"&&selectedPerson.length>0&&typeof selectedPerson.attr("data-isTypeAhead")!="undefined"&&selectedPerson.attr("data-isTypeAhead").length>0?selectedPerson.attr("data-isTypeAhead"):"false"):relationshipEventType&&typeof FactEditModal.originalSpouseId!="undefined"&&FactEditModal.originalSpouseId!=null&&FactEditModal.originalSpouseId.length>0&&typeof FactEditModal.newSpouseId!="undefined"&&FactEditModal.newSpouseId!=null&&FactEditModal.newSpouseId.length>0&&FactEditModal.originalSpouseId!==FactEditModal.newSpouseId&&(eventChanged=!0,relationshipId=FactEditModal.newSpouseId),saveValue="",FactEditModal.hasValidationError||(eventChanged&&narrativeChanged?saveValue="0":eventChanged?saveValue="1":narrativeChanged&&(saveValue="2")),typeof isSpouseDataValidate!="undefined"&&isSpouseDataValidate!==!0||typeof originalDateVal=="undefined"||typeof dateField=="undefined"||originalDateVal===dateField||FactEditModal.hasValidationWarningAgainstSpouseData||!relationshipEventType||FactEditModal.validatedAgainstSpouseData[relationshipId]!=="undefined"&&(FactEditModal.validatedAgainstSpouseData[relationshipId]==="undefined"||FactEditModal.validatedAgainstSpouseData[relationshipId])||(eventChanged=validateRelationshipEventAgainstSpouseData(selectedPerson,eventType,dateField,!1),FactEditModal.hasValidationWarningAgainstSpouseData=!eventChanged,FactEditModal.validatedAgainstSpouseData[relationshipId]=!0),relationshipEventType&&eventChanged&&(FactEditModal.originalSpouseId=relationshipId),typeof assertionid!="undefined"&&assertionid!=null&&saveValue.length>0&&(eventChanged||narrativeChanged))handleButtonsSavingMode(),url="/tree/"+PersonCard.treeId+"/person/"+PersonCard.personId+"/assertionid/"+assertionid+"/savepersonnarrativeandeventdata",$.ajax({type:"POST",url:url,cache:!1,timeout:2e4,data:{saveContentValue:saveValue,title:lifestoryTitleField,narrative:narrativeField,isHidden:!displayOnLifeStory,isMapOn:$(".narrativeIsMapOn").length>0&&$(".narrativeIsMapOn").val().length>0?$(".narrativeIsMapOn").val():!1,isImageOn:$(".narrativeIsImageOn").length>0&&$(".narrativeIsImageOn").val().length>0?$(".narrativeIsImageOn").val():!1,preferredImageId:$(".narrativePreferredImageId").length>0&&$(".narrativePreferredImageId").val().length>0?$(".narrativePreferredImageId").val():"",eventId:assertionid,eventType:eventType,customEventTitle:titleField,date:dateField,place:placeField,placeGpid:placeGpid,description:valueField!=null&&valueField.length>0?valueField:descriptionField,relationshipId:relationshipId,relTypeAhead:relTypeAheadVal,isPrimary:isPrimary,givenName:givenNameField,surname:surnameField,suffixName:suffixNameField,genderType:genderTypeField},success:function(data){var cancelClose,factItem,fullname,preferredStored,splitTitle,existingDate,factDesc,preferredEventStored,successBanner,narrativeTextArea,lifestoryTitle,displayLifestory;if(handleButtonsNormalMode(),data.result){if(FactEditModal.hasValidationWarningAgainstSpouseData=!1,cancelClose=$(".cancelClose"),eventChanged){if(cancelClose.length>0&&cancelClose.text(FactEditModal.text.close),isRelationshipEventType()&&window.glue.reload(),factItem=$("#fi"+assertionid),eventType==="Name")setFieldValidationValues(dictionary),fullname=(givenNameField.length>0?givenNameField:"")+(surnameField.length>0?(givenNameField.length>0?" ":"")+surnameField:"")+(suffixNameField.length>0?" "+suffixNameField:""),factItem.find(".cardTitle").text(fullname),isPrimary===!0&&($("#personCard .userCardTitle").text(fullname),PersonCard.name=fullname,handleFactModalUserCardData(".userCardTitle",fullname),setOldPreferredCard("preferredEventName"),setNewPreferredCard(factItem,"preferredEventName"),setAndRetrieveStoredFactValues(factItem,"givenNameStored"+assertionid,givenNameField),setAndRetrieveStoredFactValues(factItem,"surnameStored"+assertionid,surnameField),setAndRetrieveStoredFactValues(factItem,"suffixStored"+assertionid,suffixNameField),preferredStored=factItem.find(".preferredStored"+assertionid),preferredStored.length>0?preferredStored.val(modalEditEvent.find(".isPrimaryCheckbox").prop("checked")):factItem.append('<input class="preferredStored'+assertionid+'" type="hidden" value="'+modalEditEvent.find(".isPrimaryCheckbox").prop("checked")+'" />')),originalIsPrimary.toLowerCase()!==isPrimary.toString()&&($("html").data("factItemNeedsRefocus",$(".factItemFocused").attr("id")),window.glue.reload());else if(eventType==="Gender")window.location.reload();else{if(typeof titleField!="undefined"&&titleField.length>0&&(factItem.find(".cardSubtitle").text(titleField),modalTitle=$(".modalHeader").find(".modalTitle"),modalTitle.length>0&&(splitTitle=modalTitle.text().split(" "),splitTitle.length>0&&modalTitle.text(splitTitle[0]+" "+titleField)),modalEditEvent.find(".titleField").val(titleField),modalEditEvent.find(".titleField").attr("data-original-value",titleField)),(typeof originalIsPrimary!="undefined"&&typeof isPrimary!="undefined"&&originalIsPrimary.toLowerCase()!==isPrimary.toString()||typeof originalDateVal!="undefined"&&typeof dateField!="undefined"&&(originalDateVal!==dateField||originalDateVal.indexOf(data.dateYear)===-1||dateField.length===0))&&($("html").data("factItemNeedsRefocus",$(".factItemFocused").attr("id")),window.glue.reload()),setFieldValidationValues(dictionary),modalEditEvent.find(".isPrimaryCheckbox").prop("checked",isPrimary),typeof dateField!="undefined"&&dateField.length>0?factItem.find(".factItemDate").length>0?factItem.find(".factItemDate").text(dateField):factItem.find(".factItemLocation").length>0?factItem.find(".factItemLocation").before('<span class="factItemDate">'+dateField+"<\/span> &bull; "):factItem.find(".cardTitle").append('<span class="factItemDate">'+dateField+"<\/span>"):factItem.find(".factItemDate").length>0&&factItem.find(".factItemDate").remove(),typeof placeField!="undefined"&&placeField.length>0?factItem.find(".factItemLocation").length>0?factItem.find(".factItemLocation").text(placeField):factItem.find(".factItemDate").length>0?factItem.find(".factItemDate").after(' &bull; <span class="factItemLocation">'+placeField+"<\/span>"):factItem.find(".cardTitle").append('<span class="factItemLocation">'+placeField+"<\/span>"):factItem.find(".factItemLocation").length>0&&(factItem.find(".factItemDate").length>0?(existingDate=factItem.find(".factItemDate"),factItem.find(".cardTitle").html('<span class="factItemDate">'+existingDate.text()+"<\/span>")):factItem.find(".factItemLocation").remove()),factDesc=factItem.find(".factDesc"),factDesc.length>0&&typeof valueField!="undefined"&&valueField.length>0&&factItem.find(".factDesc").text(valueField),factDesc.length>0&&typeof descriptionField!="undefined"&&descriptionField.length>0?factItem.find(".factDesc").text(descriptionField):typeof descriptionField!="undefined"&&descriptionField.length>0&&factDesc.length===0?factItem.find(".cardTitle").after('<p class="factDesc textWrap">'+descriptionField+"<\/p>"):typeof descriptionField!="undefined"&&descriptionField.length===0&&factDesc.length>0&&factItem.find(".factDesc").remove(),isPrimary===!0){var hasBirth=PersonCard.lifeYearRange.indexOf("&ndash;")>0||PersonCard.lifeYearRange.indexOf("-")>0,hasDeath=(PersonCard.lifeYearRange.indexOf("&ndash;")===0||PersonCard.lifeYearRange.indexOf("-")===0)&&PersonCard.lifeYearRange.length>7||PersonCard.lifeYearRange.length>11,splitYears=PersonCard.lifeYearRange.indexOf("&ndash;")!==-1?PersonCard.lifeYearRange.split("&ndash;"):PersonCard.lifeYearRange.split("-"),eventResults=validDate(dateField,eventType.toString().toLowerCase(),FactEditModal.person.personBirth,FactEditModal.person.personDeath,FactEditModal.person.motherBirth,FactEditModal.person.motherDeath,FactEditModal.person.fatherBirth,FactEditModal.person.fatherDeath,!1),dateSet="";typeof dateField!="undefined"&&typeof placeField!="undefined"&&isPrimary===!0&&eventType.toString()==="Birth"?(window.getPersonCard(),dateSet=(eventResults[0]===0?eventResults[1]:splitYears.length>0&&hasBirth?splitYears[0]:"")+"&ndash;"+(splitYears.length>0&&hasDeath?splitYears.length>1?splitYears[1]:splitYears[0]:""),PersonCard.lifeYearRange=dateSet,dateSet.length>1&&dateSet!=="&ndash;"?handleFactModalUserCardData(".userCardSubTitle","("+dateSet.replace("&ndash;","-")+")"):handleFactModalUserCardData(".userCardSubTitle","")):typeof dateField!="undefined"&&typeof placeField!="undefined"&&isPrimary===!0&&eventType.toString()==="Death"&&(window.getPersonCard(),dateSet=(splitYears.length>0&&hasBirth?splitYears[0]:"")+"&ndash;"+(eventResults[0]===0?eventResults[1]:splitYears.length>0&&hasDeath?splitYears.length>1?splitYears[1]:splitYears[0]:""),PersonCard.lifeYearRange=dateSet,dateSet.length>1&&dateSet!=="&ndash;"?handleFactModalUserCardData(".userCardSubTitle","("+dateSet.replace("&ndash;","-")+")"):handleFactModalUserCardData(".userCardSubTitle",""))}isPrimary===!0&&(setOldPreferredCard("preferredEvent"+eventType.toString()),setNewPreferredCard(factItem,"preferredEvent"+eventType.toString()),typeof dateField!="undefined"&&setAndRetrieveStoredFactValues(factItem,"dateStored"+assertionid,dateField),typeof placeField!="undefined"&&setAndRetrieveStoredFactValues(factItem,"placeStored"+assertionid,placeField),typeof descriptionField!="undefined"&&setAndRetrieveStoredFactValues(factItem,"descriptionStored"+assertionid,descriptionField),preferredEventStored=factItem.find(".preferredEventStored"+assertionid),preferredEventStored.length>0?preferredEventStored.val(modalEditEvent.find(".isPrimaryCheckbox").prop("checked")):factItem.append('<input class="preferredEventStored'+assertionid+'" type="hidden" value="'+modalEditEvent.find(".isPrimaryCheckbox").prop("checked")+'" />'))}isCreateRelationshipEvent&&showIndividualSpouse()}saveValue.length>0&&(successBanner=$(".tabActive").find(".alertSuccess"),successBanner.length>0&&switchOnSuccessBanner(successBanner),setupCreateOrSaveTextButton(),$.modal.center());narrativeChanged&&(narrativeTextArea=$("#narrative"),narrativeTextArea.length>0&&(narrativeTextArea.text(narrativeField),narrativeTextArea.val(narrativeField),narrativeTextArea.attr("data-original-narrative",narrativeField)),lifestoryTitle=$(".lifestoryTitleField"),lifestoryTitle.length>0&&lifestoryTitle.attr("value",lifestoryTitleField).attr("data-original-lifestorytitle",lifestoryTitleField),displayLifestory=$("#displayLifestory"),displayLifestory.length>0&&displayLifestory.prop("checked",displayOnLifeStory).attr("data-original-displaylifestory",displayOnLifeStory.toString()),modalNarrative.removeClass("loading").find(".narrativeDataFields").show(),cancelClose.length>0&&cancelClose.text(FactEditModal.text.close),narrativeField.length===0&&factEditModalTimelineOptions(PersonCard.treeId,PersonCard.personId,assertionid))}},error:function(xhr,ajaxOptions,thrownError){throwException("status->"+xhr.status+" thrownError->"+thrownError);handleButtonsNormalMode()}});else if(FactEditModal.hasValidationError)return setButtonandBannerBasedOnValidation(!0),!1;return!0}function factEditModalHandleTabClick(selector,newPid,clearBanners,showBannerVal,getMedia){personAnalyticsTrackClick(selector);switch(selector){case"factEditModalEvent":case"editModalSaveButton":savePersonNarrativeAndEventDataModal(FactEditModal.assertionId,newPid,"",!0,clearBanners)&&resetEventDetails();break;case"factEditModalAttachMedia":if(!FactEditModal.mediaLoaded||getMedia){if(savePersonNarrativeAndEventDataModal(FactEditModal.assertionId,newPid,"",!1,clearBanners))return factEditModalAttachedMedia(showBannerVal)}else return savePersonNarrativeAndEventDataModal(FactEditModal.assertionId,newPid,"",!1,clearBanners);break;case"factEditModalSourceCitations":if(savePersonNarrativeAndEventDataModal(FactEditModal.assertionId,newPid,"",!1,clearBanners))return factEditModalSources(showBannerVal);break;case"factEditModalTimelineOptions":if(savePersonNarrativeAndEventDataModal(FactEditModal.assertionId,newPid,"",!1,clearBanners))return factEditModalTimelineOptions(FactEditModal.treeId,FactEditModal.personId,FactEditModal.assertionId)}return!0}function factEditModalAttachedMedia(hasBanner){var addMediaSection=$("#addMediaSection"),url;addMediaSection.hide().closest(".tabContent").removeClass("showUpload");url="/modals/factedit/tree/"+FactEditModal.treeId+"/person/"+FactEditModal.personId+"/assertionid/"+FactEditModal.assertionId+"/attachedmedia?noRecordMedia=true";$.ajax({type:"GET",url:url,cache:!1,timeout:2e4,data:{eventType:FactEditModal.eventType,eventTitle:FactEditModal.eventTitle},success:function(data){var tabActive=$(".tabActive"),attachedMediaList=tabActive.find(".attachedMediaList"),hasFactMediaError,$sortingDivTopAlert,$sortingDivBottomAlert,bannerArea;data.result&&data.html!=null&&data.html.length>0?(tabActive.removeClass("loading"),attachedMediaList.html(data.html),$(".attachedMediaList").find(".alertNote").alert(personViewModalAlertSettingsNote).end().find(".alertInfo").alert(personViewModalAlertSettingsInfo).end().find(".alertSuccess").alert(personViewModalAlertSettingsSuccess).end().find(".alert:not(.alertNote):not(.alertInfo):not(.alertSuccess)").alert(personViewModalAlertSettingsWarning),hasFactMediaError=$("#hasFactMediaError"),hasFactMediaError.length>0&&hasFactMediaError.val()==="true"?($(".sortingDivTopFactNoAttachedMediaMSG").alert("close"),$(".sortingDivTopFactErrorMSG").alert("open"),$(".sortingDivBottomFactNoMediaMSG").alert("close"),$(".sortingDivBottomFactErrorMSG").alert("open")):(FactEditModal.mediaLoaded=!0,(typeof PersonData!="undefined"&&PersonData.hasEditRights||PersonData.hasContributorRights)&&addMediaSection.show().closest(".tabContent").addClass("showUpload"),factEditModalMedia(data.attachedMediaIds,data.unAttachedMediaIds),sortingCardOutlineHover(),$sortingDivTopAlert=$(".sortingDivTopFactMedia .sortingDivTopFactNoAttachedMediaMSG"),$sortingDivBottomAlert=$(".sortingDivBottomFactMedia .sortingDivBottomFactNoMediaMSG"),$sortingDivTopAlert.alert(personViewModalAlertSettingsNote),$sortingDivBottomAlert.alert(personViewModalAlertSettingsNote),$.cachedScript(typeof PersonData!="undefined"&&PersonData.animateCardUrl).done(function(){$(".sortingDivBottomFactMedia").animateCard({animateMove:{afterAnimate:function(item){item.find(".sortingIcon").hasClass("iconAdd")?(item.removeClass("cardOutline2").addClass("attached"),(PersonData.hasEditRights||PersonData.hasContributorRights)&&item.find(".sortingIcon").removeClass("iconAdd noHover").addClass("iconClose")):(item.removeClass("cardOutline2").removeClass("attached"),(PersonData.hasEditRights||PersonData.hasContributorRights)&&item.find(".sortingIcon").removeClass("iconClose noHover").addClass("iconAdd"));window.lock.actionInProgress=!1},beforeAnimate:function(item){item.find(".card").addClass("cardOutline2")},connectWith:".sortingDivTopFactMedia",emptyContent:".alertNote"},items:".card",onListEmpty:function(emptyList){emptyList.find(".alertNote").alert("open")},onEmptyListAdd:function(list){list.find(".alertNote").alert("close")}})}),$(".sortingDivTopFactMedia .card").length===0&&$sortingDivTopAlert.alert("open"),$(".sortingDivBottomFactMedia .card").length===0&&$sortingDivBottomAlert.alert("open"),bannerArea=$(".tabActive").find(".alertSuccess"),typeof hasBanner!="undefined"&&hasBanner==="true"&&bannerArea.length>0&&(switchOnSuccessBanner(bannerArea),setFactModalTabsClick(!FactEditModal.hasValidationError)))):($(".sortingDivTopFactNoAttachedMediaMSG").alert("close"),$(".sortingDivTopFactErrorMSG").alert("open"),$(".sortingDivBottomFactNoMediaMSG").alert("close"),$(".sortingDivBottomFactErrorMSG").alert("open"),tabActive.removeClass("loading"))},error:function(){$(".sortingDivTopFactNoAttachedMediaMSG").alert("close");$(".sortingDivTopFactErrorMSG").alert("open");$(".sortingDivBottomFactNoMediaMSG").alert("close");$(".sortingDivBottomFactErrorMSG").alert("open")}});resetValidationValues()}function resetEventDetails(){var modalEditEvent=$(".tabContent1");modalEditEvent.find(".factField").each(function(){var $field=$(this),originalVal;$field.attr("name")!=="gender"&&(originalVal=$field.data("original-value"),$field.val(originalVal))});clearAllBanners();$(".editModalSaveButton").removeAttr("disabled");setFactModalTabsClick(!FactEditModal.hasValidationError)}function resetValidationValues(){FactEditModal.hasValidationWarning=!1;FactEditModal.hasValidationDateWarning=!1;FactEditModal.validationWarningMessage="";FactEditModal.hasValidationError=!1;FactEditModal.validationErrorMessage="";FactEditModal.hasValidationWarningToSelectSpouse=!1}function validateAndSetupDisplay(element){resetValidationValues();typeof element!="undefined"&&validateField(element);setButtonandBannerBasedOnValidation(!0)}function factEditModalMedia(attachedMediaIds,unAttachedMediaIds){attachedMediaIds.length>0&&setupFactEditModalDetailsForMedia(attachedMediaIds,FactEditModal.assertionId);unAttachedMediaIds.length&&setupFactEditModalDetailsForMedia(unAttachedMediaIds,FactEditModal.assertionId)}function validateField(el){var origVal,eventResults,eventValidationValues,surname,validationNameMessage,msg;if(typeof el!="undefined"){var isjQueryObj=el instanceof jQuery,$element=isjQueryObj?el:$(el),value=$element.val();return value.length===0?($element.data("state","0"),$element.data("msg",""),0):$element.hasClass("dateField")?value.charAt(0)==="\\"||value.charAt(date.length-1)==="\\"?($element.data("state","3"),msg=FactEditModal.text.warnDateMayBeWrong+" "+FactEditModal.text.warnInvalidCharacterStartEndDate,$element.data("msg",msg),3):(origVal=$element.data("original-value"),typeof origVal!="undefined"&&origVal===value)?($element.data("state","1"),$element.data("msg",""),1):(eventResults=validDate(value,FactEditModal.eventType.toLowerCase(),FactEditModal.person.personBirth,FactEditModal.person.personDeath,FactEditModal.person.motherBirth,FactEditModal.person.motherDeath,FactEditModal.person.fatherBirth,FactEditModal.person.fatherDeath,!1),eventValidationValues=validationCheck(FactEditModal.eventType.toLowerCase(),eventResults),eventValidationValues.hasValidationWarning?($element.data("state","3"),$element.data("msg",eventValidationValues.validationMessage),3):($element.data("state","2"),$element.data("msg",""),2)):$element.hasClass("surnameField")?(surname=$element.val(),validationNameMessage=validateSurname(surname,FactEditModal.person.fatherSurname,FactEditModal.person.spouseSurname,FactEditModal.gender,FactEditModal.normalSurnameValidation),validationNameMessage.length>0?($element.data("state","3"),msg=FactEditModal.validationWarningMessage.length>0?FactEditModal.validationWarningMessage+"  "+validationNameMessage:validationNameMessage,$element.data("msg",msg),typeof surname=="undefined"||FactEditModal.person.fatherSurname===surname)?($element.data("state","2"),$element.data("msg",""),2):3:($element.data("state","2"),$element.data("msg",""),2)):($element.data("state","2"),$element.data("msg",""),2)}}function handleButtonsSavingMode(){$(".editModalSaveButton").addClass("loading disabled").attr("aria-busy","true");var cancelClose=$(".cancelClose");cancelClose.length>0&&cancelClose.hide()}function handleButtonsNormalMode(){$(".editModalSaveButton").removeAttr("disabled aria-busy").removeClass("loading disabled");var cancelClose=$(".cancelClose");cancelClose.length>0&&cancelClose.show()}function setFieldValidationValues(dictionary){var modalEditEvent=$(".tabContent1");modalEditEvent.find(".factField").each(function(){var $field=$(this),field;$field.attr("name")=="gender"?(field=dictionary[$field.attr("id")],field!="undefined"?($field.attr("checked",!0),$field.data("state",1),$field.val(field.value),$field.data("original-value",field.value)):($field.attr("checked",!1),$field.data("state",0),$field.val(""),$field.data("original-value",""))):(field=dictionary[$field.attr("id")],field!="undefined"?($field.data("state",field.value.length===0?0:1),$field.val(field.value),$field.data("original-value",field.value),field.extra.length>0&&$field.data("extra",field.extra)):($field.data("state",0),$field.val(""),$field.data("original-value",""),$field.data("extra","")))})}function setupFactEditModalDetailsForMedia(eventMediaIds,factId){var getTrackingId=function(isAttached){return isAttached?"editFactModalRemoveMedia":"editFactModalAttachMedia"},mediaList=eventMediaIds.split(",");mediaList!=null&&mediaList.length>0&&$.each(mediaList,function(i,mediaId){setupCardClickEvent(mediaId,getTrackingId,function(isAttached,attachDetachCallback){isAttached?detachMediaFromEvent(factId,mediaId,attachDetachCallback):attachMediaToEvent(factId,mediaId,attachDetachCallback)})})}function setupSourceEditModalDetailsForMedia(eventMediaIds,sourceId){var getTrackingId=function(isAttached){return isAttached?"removeMediaFromCitation":"attachMediaToCitation"},mediaList=eventMediaIds.split(",");mediaList!=null&&mediaList.length>0&&$.each(mediaList,function(i,mediaId){setupCardClickEvent(mediaId,getTrackingId,function(isAttached,attachDetachCallback){isAttached?detachMediaFromCitation(sourceId,mediaId,attachDetachCallback):attachMediaToCitation(sourceId,mediaId,attachDetachCallback)})})}function setupCardClickEvent(cardId,getTrackingId,makeServerCall){var $card=$("#"+cardId);$card.on("click.card","button.sortingIcon",function(e){var isAttached,attachDetachCallback;e.preventDefault();isAttached=$card.hasClass("attached");personAnalyticsTrackClick(getTrackingId(isAttached));clearAllBanners();attachDetachCallback=function(data){data&&data.result&&($card.trigger("animateListItem.move"),saveUIState($(".factItemFocused")),window.glue.reload(function(){loadUIState("click")}))};typeof makeServerCall=="function"&&makeServerCall(isAttached,attachDetachCallback)})}function factEditModalSources(hasBanner){var eventSourcesList=$(".eventSourcesList"+FactEditModal.assertionId),unattachedEventSourcesList,bannerArea;eventSourcesList.length>0&&eventSourcesList.val()!=null&&eventSourcesList.val().length>0&&setupFactEditModalDetailsForSource(eventSourcesList,!0);unattachedEventSourcesList=$(".unattachedEventSourcesList"+FactEditModal.assertionId);unattachedEventSourcesList.length>0&&unattachedEventSourcesList.val()!=null&&unattachedEventSourcesList.val().length>0&&setupFactEditModalDetailsForSource(unattachedEventSourcesList,!1);bannerArea=$(".tabActive").find(".alertSuccess");typeof hasBanner!="undefined"&&hasBanner&&bannerArea.length>0&&(switchOnSuccessBanner(bannerArea),setFactModalTabsClick(!FactEditModal.hasValidationError))}function setupFactEditModalDetailsForSource(listItem){var getTrackingId=function(isAttached){return isAttached?"editFactModalRemoveSource":"editFactModalAddSource"},sourcesList=listItem.val().split(",");sourcesList!=null&&sourcesList.length>0&&$.each(sourcesList,function(i,sourceId){var sourceItem=$("#modal_si"+sourceId),userCardItem=$(".userCardsi"+sourceId),dbId,imgSrc,selector;if(sourceItem.length>0){if(dbId=sourceItem.find(".dbId").val(),dbId==="1030")userCardItem.find(".userCardImg").addClass("icon iconAcom");else{var sourceNode=$("#si"+sourceId),nodeUserCardImg=sourceNode.find(".userCardImg"),imgItem=nodeUserCardImg.children("img");imgItem.length>0?(imgSrc=imgItem.attr("src"),userCardItem.length>0&&(userCardItem.find(".userCardImg").html('<img class="" src="'+imgSrc+'" alt="" />'),userCardItem.find(".userCardImg").attr("style","background-image:url('"+imgSrc+"');"),userCardItem.find(".userCardImg").addClass("userCardImgSquare userCardImgCenter"))):userCardItem.find(".userCardImg").addClass("icon iconDocument")}selector="modal_si"+sourceId;setupCardClickEvent(selector,getTrackingId,function(isAttached,attachDetachCallback){isAttached?detachSourceFromEvent(FactEditModal.assertionId,sourceId,selector,attachDetachCallback):attachSourceToEvent(FactEditModal.assertionId,sourceId,selector,attachDetachCallback)})}else sourceId==="1030"?userCardItem.find(".userCardImg").addClass("icon iconAcom"):userCardItem.find(".userCardImg").addClass("icon iconDocument")})}function factEditModalTimelineOptions(treeId,personId,assertionId){var url="/modals/factedit/tree/"+treeId+"/person/"+personId+"/assertionid/"+assertionId+"/timeline";$.ajax({type:"GET",url:url,cache:!1,timeout:2e4,success:function(data){var narrativeTextArea,displayLifestory,generateNarrativeButton,lifestoryTitleField;$(".tabContent4").removeClass("loading").find(".narrativeDataFields").show();narrativeTextArea=$("#narrative");displayLifestory=$("#displayLifestory");data.result&&data.personEventNarrativeDataResponse!=null?(generateNarrativeButton=$("#generateNarrative"),generateNarrativeButton.length>0&&data.personEventNarrativeDataResponse.DefaultNarrative!=null&&data.personEventNarrativeDataResponse.DefaultNarrative.length>0&&generateNarrativeButton.show(),narrativeTextArea.length>0&&(narrativeTextArea.text(data.personEventNarrativeDataResponse.Narrative),narrativeTextArea.val(data.personEventNarrativeDataResponse.Narrative),narrativeTextArea.attr("data-original-narrative",data.personEventNarrativeDataResponse.Narrative||"")),lifestoryTitleField=$(".lifestoryTitleField"),lifestoryTitleField.length>0&&lifestoryTitleField.attr("value",data.personEventNarrativeDataResponse.Title).attr("data-original-lifestorytitle",data.personEventNarrativeDataResponse.Title),displayLifestory.length>0&&displayLifestory.prop("checked",!data.personEventNarrativeDataResponse.IsHidden).attr("data-original-displaylifestory",(!data.personEventNarrativeDataResponse.IsHidden).toString()),$(".narrativeIsMapOn").val(data.personEventNarrativeDataResponse.IsMapOn),$(".narrativeIsImageOn").val(data.personEventNarrativeDataResponse.IsImageOn),$(".narrativePreferredImageId").val(data.personEventNarrativeDataResponse.PreferredImageId)):displayLifestory.length>0&&($(".narrativeIsMapOn").val(!1),$(".narrativeIsImageOn").val(!1),displayLifestory.prop("checked",!1).attr("disabled",!0).attr("data-original-displaylifestory","false"))}})}function switchOnSuccessBanner(bannerArea){bannerArea.text(FactEditModal.text.savedSuccessfullyBanner);bannerArea.hasClass("alertHidden")&&bannerArea.alert("open")}function showMultipleSpouseSelect(){var hasSelectedPerson,selectedSpouseRadio,dontValidate,spouseCount,selectedSpouseId;$(".editModalSaveButton").unbind("click");FactEditModal.isAddNewSpouse=!1;FactEditModal.showMultipleSpouseSelected=!0;var modalEditEvent=$(".tabContent1"),individualSpouseSelect=modalEditEvent.find("#individualSpouseSelect"),multipleSpouseSelect=modalEditEvent.find("#multipleSpouseSelect"),selectedPerson=modalEditEvent.find(".selectedPerson");isRelationshipEventType()&&selectedPerson.length===0&&(selectedPerson=modalEditEvent.find(".selectedPerson"));hasSelectedPerson=typeof selectedPerson!="undefined"&&selectedPerson.length>0;hasSelectedPerson&&(selectedSpouseId=selectedPerson.attr("id").replace("selectedSpouse","").replace("-individual",""),selectedSpouseRadio=$("#selectedSpouseRadio"+selectedSpouseId),selectedSpouseRadio.attr("checked","checked"),selectedPerson.hide());$("#changeSpouseButton").hide();$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();");dontValidate=!1;spouseCount=parseInt(FactEditModal.person.spouseCount);FactEditModal.isAddNewFact||spouseCount!==1||typeof FactEditModal.originalSpouseId=="undefined"||FactEditModal.originalSpouseId.length!==0?!FactEditModal.isAddNewFact&&spouseCount>1&&typeof FactEditModal.originalSpouseId!="undefined"&&FactEditModal.originalSpouseId.length===0?(individualSpouseSelect.hide(),$("#spouseText").hide(),$("#selectSpouseForEventText").show(),multipleSpouseSelect.show(),$("#noSpouseForEventSingle").hide(),$("#noSpouseForEventMulti").show(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();")):spouseCount===1?(hasSelectedPerson&&(selectedSpouseId=selectedPerson.attr("id").replace("selectedSpouse","").replace("-individual",""),resetIndividualSpouseNode(selectedPerson,selectedSpouseId)),setIndividualSpouseData(modalEditEvent,".singleScenarioSpouseSelect"),dontValidate=!0,individualSpouseSelect.show(),multipleSpouseSelect.hide()):spouseCount===0?($("#noSpouseChooseOther").show(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();")):(individualSpouseSelect.hide(),$("#spouseText").hide(),$("#selectSpouseForEventText").show(),multipleSpouseSelect.show().addClass("multipleSpouseSelected"),FactEditModal.previousSelectedSpouseHTML.length>0&&FactEditModal.previousSelectedSpouseHTML.indexOf("selectedPerson")!==-1&&modalEditEvent.find("#individualSpouseSelect").html(FactEditModal.previousSelectedSpouseHTML)):(individualSpouseSelect.hide(),multipleSpouseSelect.show(),$("#singleScenarioSpouseSelect").show(),$("#noSpouseForEventSingle").show(),$("#noSpouseForEventMulti").hide(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();"));dontValidate||hasSelectedPerson?FactEditModal.isAddNewFact?setAddNewFactCreateAction():setFactModalTabsClick(FactEditModal.hasValidationError):setFactActionWithValidate();$.modal.center()}function showIndividualSpouse(){var singleScenarioSpouseSelect,existingSpouseIndividual2;FactEditModal.isAddNewSpouse=!1;FactEditModal.showMultipleSpouseSelected=!1;var modalEditEvent=$(".tabContent1"),individualSpouseSelect=modalEditEvent.find("#individualSpouseSelect"),multipleSpouseSelect=modalEditEvent.find("#multipleSpouseSelect"),spouseCount=parseInt(FactEditModal.person.spouseCount);if(spouseCount>=1&&(singleScenarioSpouseSelect=$("#singleScenarioSpouseSelect"),spouseCount===1&&singleScenarioSpouseSelect.length>0&&typeof $("#singleScenarioSpouseSelect").attr("style").length!="undefined"&&$("#singleScenarioSpouseSelect").attr("style").length===0?($("#changeSpouseButton").hide(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();")):($("#changeSpouseButton").show().attr("onClick","showMultipleSpouseSelect();"),$("#chooseOtherButton").hide())),$("#spouseText").show(),$("#selectSpouseForEventText").hide(),setIndividualSpouseData(modalEditEvent,".selectedPerson"))$("#noSpouseForEventSingle").hide(),$("#noSpouseForEventMulti").hide();else return!1;return spouseCount>0&&(individualSpouseSelect.show(),multipleSpouseSelect.hide()),existingSpouseIndividual2=individualSpouseSelect.find(".existingSpouseIndividual"),existingSpouseIndividual2.length>0&&existingSpouseIndividual2.hasClass("selectedPerson")&&existingSpouseIndividual2.show(),multipleSpouseSelect.removeClass("multipleSpouseSelected"),$.modal.center(),!0}function showIndividualSpouseCommon(modalEditEvent,selectedPerson,selectedSpouseIndividual){typeof selectedPerson!="undefined"&&selectedPerson.length>0&&(selectedPerson.removeClass("selectedPerson").removeAttr("style"),selectedSpouseIndividual.addClass("selectedPerson").attr("data-assertionId",selectedPerson.attr("data-assertionId")).attr("data-spouseLifeRange",selectedPerson.attr("data-spouseLifeRange")),setEditModalSaveButtonClick())}function validateRelationshipEventAgainstSpouseData(selectedPerson,eventType,dateField,isCreate){var hasValidationWarning=!1,validationMessage=FactEditModal.text.warnDateMayBeWrong+"  ",relationshipLifeRange,lifeRangeSplit,eventResults;return(overrideValidation(),FactEditModal.hasValidationWarning=!1,FactEditModal.validationWarningMessage="",FactEditModal.warningMessage="",relationshipLifeRange=typeof selectedPerson!="undefined"&&selectedPerson.length>0&&typeof selectedPerson.attr("data-spouseLifeRange")!="undefined"&&selectedPerson.attr("data-spouseLifeRange").length>0?selectedPerson.attr("data-spouseLifeRange").trim():"",relationshipLifeRange.length>0&&relationshipLifeRange.indexOf(":")!==-1&&(lifeRangeSplit=relationshipLifeRange.split(":"),eventResults=validDate(dateField,eventType.toString().toLowerCase(),FactEditModal.person.personBirth,FactEditModal.person.personDeath,FactEditModal.person.motherBirth,FactEditModal.person.motherDeath,FactEditModal.person.fatherBirth,FactEditModal.person.fatherDeath,!1),lifeRangeSplit[0].length>0&&parseInt(eventResults[1],10)<lifeRangeSplit[0]&&(hasValidationWarning=!0,validationMessage+=warnDateBeforeBirthOfSpouse),lifeRangeSplit[1].length>0&&parseInt(eventResults[1],10)>lifeRangeSplit[1]&&(hasValidationWarning=!0,validationMessage+=warnDateAfterDeathOfSpouse),hasValidationWarning))?(FactEditModal.hasValidationWarning=!0,FactEditModal.validationWarningMessage="",FactEditModal.warningMessage="",setupCreateOrSaveAnywayTextButton(),isCreate?setAddNewFactCreateAction():setFactModalTabsClick(FactEditModal.hasValidationError),!1):!0}function showSpouseTypeAheadSection(){var typeAheadCancelButton,typeAheadAddPersonButton,typeAheadSaveButton,$typeAheadNameField;FactEditModal.isAddNewSpouse=!0;var modalEditEvent=$(".tabContent1"),selectedPerson=modalEditEvent.find(".selectedPerson"),spouseCount=parseInt(FactEditModal.person.spouseCount);$("#noSpouseForEventMulti").hide();$("#noSpouseForEventSingle").hide();FactEditModal.previousSelectedSpouseHTML=modalEditEvent.find("#individualSpouseSelect").html();typeof selectedPerson!="undefined"&&selectedPerson.length>0&&resetIndividualSpouseNode(selectedPerson,"");spouseCount===0&&$("#noSpouseChooseOther").hide();$("#individualSpouseSelect").hide();$("#multipleSpouseSelect").hide();$("#selectSpouseForEventText").hide();$("#changeSpouseButton").hide();$("#chooseOtherButton").hide();$("#spouseText").show();$("#typeAheadArea").show();$(".addRelationships").show();typeAheadCancelButton=$(".erAddCancel");typeAheadCancelButton.length>0&&typeAheadCancelButton.attr("onClick","hideSpouseTypeAheadSection();");typeAheadAddPersonButton=$(".erAddNew");typeAheadAddPersonButton.length>0&&typeAheadAddPersonButton.attr("onClick","spouseTypeAheadSectionAddPersonModal();");typeAheadSaveButton=$(".erAddSave");$typeAheadNameField=$(".erFindExistingPerson");$typeAheadNameField.length>0&&typeAheadSaveButton.length>0&&(typeAheadSaveButton.attr("onClick","selectFromSpouseTypeAhead(this);"),$typeAheadNameField.data("itemData",""),typeAheadSaveButton.attr("disabled","disabled"),personTypeAheadNameField($typeAheadNameField,FactEditModal.autocompletePidsToExclude,typeAheadSaveButton,"factEditModal",!1));setupCreateOrSaveTextButton();setupCorrectClickActionLinks();$.modal.center()}function hideSpouseTypeAheadSection(){var modalEditEvent,spouseCount,$typeAheadNameField;FactEditModal.isAddNewSpouse=!1;FactEditModal.previousSelectedSpouseHTML.length>0&&FactEditModal.previousSelectedSpouseHTML.indexOf("selectedPerson")!==-1&&(modalEditEvent=$(".tabContent1"),modalEditEvent.find("#individualSpouseSelect").html(FactEditModal.previousSelectedSpouseHTML),FactEditModal.previousSelectedSpouseHTML="");spouseCount=parseInt(FactEditModal.person.spouseCount);spouseCount>1?(FactEditModal.showMultipleSpouseSelected=!0,$("#spouseText").hide(),$("#selectSpouseForEventText").show()):(FactEditModal.showMultipleSpouseSelected=!1,$("#spouseText").show(),$("#selectSpouseForEventText").hide());$("#typeAheadArea").hide();$typeAheadNameField=$(".erFindExistingPerson");$typeAheadNameField.length>0&&$typeAheadNameField.data("itemData","");FactEditModal.hasExistingSpouseToSelect?FactEditModal.showMultipleSpouseSelected||$("#singleScenarioSpouseSelect").attr("style").length===0?($("#multipleSpouseSelect").show(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();"),FactEditModal.isAddNewFact||spouseCount!==1||FactEditModal.originalSpouseId.length!==0?!FactEditModal.isAddNewFact&&spouseCount>1&&FactEditModal.originalSpouseId.length===0&&($("#noSpouseForEventSingle").hide(),$("#noSpouseForEventMulti").show()):($("#noSpouseForEventSingle").show(),$("#noSpouseForEventMulti").hide())):($("#individualSpouseSelect").show(),spouseCount>1?$("#changeSpouseButton").show().attr("onClick","showMultipleSpouseSelect();"):$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();")):spouseCount===0&&($("#noSpouseChooseOther").show(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();"));setupCreateOrSaveTextButton();setupCorrectClickActionLinks();$.modal.center()}function resetIndividualSpouseNode(selectedPerson,selectedSpouseId){typeof selectedPerson!="undefined"&&selectedPerson.length>0&&(selectedPerson.removeClass("selectedPerson").removeAttr("style"),FactEditModal.previousSelectedSpouseId=selectedSpouseId,FactEditModal.hasValidationWarningAgainstSpouseData=!1,selectedPerson.attr("id","selectedSpouse-individual"),selectedPerson.find(".nodeImageDiv").html(""),selectedPerson.find(".userCardTitle").text(""),selectedPerson.find(".userCardSubTitle").text(""),selectedPerson.attr("data-assertionId","0"))}function setFactActionWithValidate(){FactEditModal.isAddNewFact?setAddNewFactCreateAction():setFactModalTabsClick(FactEditModal.hasValidationError)}function switchSelectedPersonClass(selectedItem){var modalEditEvent=$(".tabContent1"),selectedPerson=modalEditEvent.find(".selectedPerson"),origSelectedSpouseId,selectedSpouseRadio;isRelationshipEventType()&&selectedPerson.length===0&&(selectedPerson=modalEditEvent.find(".selectedPerson"));typeof selectedPerson!="undefined"&&selectedPerson.length>0&&typeof selectedPerson.attr("id")!="undefined"&&(origSelectedSpouseId=selectedPerson.attr("id").replace("selectedSpouse","").replace("-individual",""),resetIndividualSpouseNode(selectedPerson,origSelectedSpouseId));var selectedSpouseId=selectedItem.id.replace("selectedSpouseRadio",""),selectedSpouseItem=$("#selectedSpouse"+selectedSpouseId),spouseCount=parseInt(FactEditModal.person.spouseCount);(FactEditModal.isAddNewFact||spouseCount>0)&&(clearAllBanners(),typeof selectedSpouseItem!="undefined"&&selectedSpouseItem.length>0&&(selectedSpouseRadio=$("#selectedSpouseRadio"+FactEditModal.previousSelectedSpouseId),selectedSpouseRadio.removeAttr("checked"),selectedSpouseItem.addClass("selectedPerson")));FactEditModal.showMultipleSpouseSelected=!1;(spouseCount===1||spouseCount>1)&&(spouseCount===1&&$("#singleScenarioSpouseSelect").attr("style").length===0?($("#changeSpouseButton").hide(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();")):($("#changeSpouseButton").show().attr("onClick","showMultipleSpouseSelect();"),$("#chooseOtherButton").hide()));$("#spouseText").show();setFactActionWithValidate();setButtonandBannerBasedOnValidation(!1)}function setIndividualSpouseData(modalEditEvent,selectedPersonClass){var selectedPerson=modalEditEvent.find(selectedPersonClass),$selectedSpouseIndividual=modalEditEvent.find("#selectedSpouse-individual");if(typeof selectedPerson!="undefined"&&selectedPerson.length>0)$selectedSpouseIndividual.attr("id",selectedPerson.attr("id")+"-individual"),$selectedSpouseIndividual.find(".nodeImageDiv").html(selectedPerson.find(".nodeImageDiv").html()),$selectedSpouseIndividual.find(".userCardTitle").text(selectedPerson.find(".userCardTitle").text()),$selectedSpouseIndividual.find(".userCardSubTitle").text(selectedPerson.find(".userCardSubTitle").text());else return!1;return showIndividualSpouseCommon(modalEditEvent,selectedPerson,$selectedSpouseIndividual),$selectedSpouseIndividual.addClass("selectedPerson"),!0}function setEditModalSaveButtonClick(){$(".editModalSaveButton").on("click",function(event){$(".editModalSaveButton").unbind("click");event.stopPropagation()})}function selectFromSpouseTypeAhead(e){var modalEditEvent=$(".tabContent1"),selectedPerson=modalEditEvent.find(".selectedPerson"),imageHtml,dates,spouseCount,selectedSpouseRadio,eventType,dateField;typeof selectedPerson!="undefined"&&selectedPerson.length>0&&(resetIndividualSpouseNode(selectedPerson,""),clearAllBanners());var $this=$(e),$card=$this.closest(".card"),$field=$card.find(".erFindExistingPerson"),data=$card.find(".erAddExistingData").data("itemData"),pid=data.PID;FactEditModal.findExistingPersonPID=pid;var personImage=data.image,personName=data.name,personBirth=data.birth,personDeath=data.death,genderIconType=data.genderIconType,selectedSpouseIndividual=modalEditEvent.find("#selectedSpouse-individual");typeof selectedSpouseIndividual!="undefined"&&selectedSpouseIndividual.length>0&&(selectedSpouseIndividual.attr("id","selectedSpouse"+FactEditModal.findExistingPersonPID+"-individual"),selectedSpouseIndividual.attr("data-isTypeAhead","true"),imageHtml="",imageHtml=personImage.indexOf("mediasvc")!==-1?'<div class="userCardImg userCardImgSquare userCardImgCenter" style="background-image:url(\''+personImage.replace('"','"')+'\');"><img alt="" src="'+personImage+'"><\/div>':'<div class="userCardImg userCardImgSquare icon icon'+genderIconType+'"><\/div>',selectedSpouseIndividual.find(".nodeImageDiv").html(imageHtml),selectedSpouseIndividual.find(".userCardTitle").text(personName),dates=personBirth.length>0&&personDeath.length>0?personBirth+" - "+personDeath:personBirth.length>0?personBirth+" - ":personDeath.length>0?" - "+personDeath:"",selectedSpouseIndividual.find(".userCardSubTitle").text(dates),selectedSpouseIndividual.hasClass("selectedPerson")||selectedSpouseIndividual.addClass("selectedPerson"),selectedSpouseIndividual.attr("data-assertionId",FactEditModal.findExistingPersonPID));$("#spouseText").show();$("#selectSpouseForEventText").hide();$field.length>0&&$field.data("itemData","");$("#typeAheadArea").hide();$("#multipleSpouseSelect").hide();$("#individualSpouseSelect").show();$(".selectedPerson").show();spouseCount=parseInt(FactEditModal.person.spouseCount);spouseCount===0?($("#noSpouseChooseOther").hide(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();")):(FactEditModal.isAddNewFact||FactEditModal.originalSpouseId.length!==0?FactEditModal.isAddNewFact&&spouseCount>0?($("#chooseOtherButton").hide(),$("#changeSpouseButton").show().attr("onClick","showMultipleSpouseSelect();")):($("#chooseOtherButton").hide(),$("#changeSpouseButton").show().attr("onClick","showMultipleSpouseSelect();")):spouseCount>=1?($("#changeSpouseButton").show().attr("onClick","showMultipleSpouseSelect();"),$("#chooseOtherButton").hide()):($("#changeSpouseButton").hide(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();")),FactEditModal.previousSelectedSpouseId.length>0&&(selectedSpouseRadio=$("#selectedSpouseRadio"+FactEditModal.previousSelectedSpouseId),selectedSpouseRadio.removeAttr("checked")));eventType=FactEditModal.eventType;dateField=modalEditEvent.find(".dateField").val();validateRelationshipEventAgainstSpouseData(selectedPerson,eventType,dateField,!0);setButtonBasedOnValidation();setupCorrectClickActionLinks()}function overrideValidation(){isRelationshipEventType()&&$(".editModalSaveButton").unbind("click");FactEditModal.warningMessage.length>0&&typeof $(".editModalSaveButton").attr("disabled")=="undefined"?setupCreateOrSaveAnywayTextButton():setupCreateOrSaveTextButton();resetValidationValues();FactEditModal.isAddNewFact&&setAddNewFactCreateAction();FactEditModal.warningMessage=""}function setupCreateOrSaveAnywayTextButton(){(isRelationshipEventType()||!isDatePlaceEventType())&&$(".editModalSaveButton").unbind("click");FactEditModal.isAddNewFact?$(".editModalSaveButton").text(FactEditModal.text.createAnyway):$(".editModalSaveButton").text(FactEditModal.text.saveAnyway);$(".editModalSaveButton").removeAttr("disabled")}function spouseTypeAheadSectionAddPersonModal(){var modalEditEvent=$(".tabContent1"),eventType=FactEditModal.eventType,dateField=modalEditEvent.find(".dateField").val(),placeField=modalEditEvent.find(".placeField").val(),descriptionField=modalEditEvent.find(".descriptionField").val(),addRelType=FactEditModal.gender==="Male"?"w":"h",genderType=FactEditModal.gender==="Male"?"F":"M",addPersonArgs='{"rel":"'+addRelType+'","gender":"'+genderType+'", "eventType": "'+eventType+'", "dateField": "'+dateField+'", "placeField": "'+placeField+'", "descriptionField": "'+descriptionField+'", "modalHeaderTitle": "'+($("#modalHeader").length>0?$("#modalHeader").text():"")+'", "showAddNewOnly": "true", "isAddNewSpouse": "true", "selectedContentArea": "tabContent1", "tabOrButtonItem": "factEditModalEvent"'+(FactEditModal.isAddNewFact?"":', "assertionid": "'+FactEditModal.assertionId+'"')+"}",addPersonPgStkArgs="pg=32768&pgpl=pid&pgps="+FactEditModal.personId,apmCallback=function(cbResponse){if(!window.isCancelClicked&&cbResponse.status==="success"){var modalContents=$("#modalContents");modalContents.length>0&&$.modal.showLoading(!0)}return FactEditModal.isAddNewFact?addNewFact(cbResponse.newPid,addPersonArgs):newFactEditModal(PersonData,FactEditModal.assertionId,"tabContent1","",cbResponse.newPid,addPersonArgs,!1),!0};AddPerson.Add(PersonData.treeId,PersonData.personId,addPersonArgs,apmCallback)}function validationCheck(eventType,eventResults){var returnValues={hasValidationWarning:!1,validationMessage:""},dateMonthYear,dateSplit;return eventResults[0]!==0&&(returnValues.hasValidationWarning=!0,returnValues.validationMessage=FactEditModal.text.warnDateMayBeWrong),dateMonthYear=FactEditModal.person.dateStamp,dateMonthYear.length>0?(dateSplit=dateMonthYear.split(","),eventResults[2]!=null&&typeof eventResults[2]!="undefined"&&eventResults[1]===dateSplit[2]&&parseInt(eventResults[2])>parseInt(dateSplit[1])||eventResults[2]!=null&&typeof eventResults[2]!="undefined"&&eventResults[1]===dateSplit[2]&&parseInt(eventResults[2])===parseInt(dateSplit[1])&&eventResults[3]!=null&&parseInt(eventResults[3])>parseInt(dateSplit[0])?(returnValues.hasValidationWarning=!0,returnValues.validationMessage=FactEditModal.text.warnDateMayBeWrong+" "+FactEditModal.text.warnDateIsInFuture):eventResults[1].length>0&&(returnValues.validationMessage=returnValues.validationMessage.length>0?returnValues.validationMessage+" "+eventResults[1]:eventResults[1])):eventResults[1].length>0&&(returnValues.validationMessage=returnValues.validationMessage.length>0?returnValues.validationMessage+" "+eventResults[1]:eventResults[1]),returnValues}function getWarningMessage(requiredEmpty,isEmpty){return requiredEmpty?isEmpty?FactEditModal.text.warnToEnterTitleAndData:FactEditModal.text.warnToEnterTitle:FactEditModal.text.warnToEnterData}function isDatePlaceEventType(){return typeof FactEditModal.datePlaceType=="undefined"&&(FactEditModal.datePlaceType=FactEditModal.eventType!=="Name"&&FactEditModal.eventType!=="Gender"),FactEditModal.datePlaceType}function addFactModal(persondata){var modalContainer,url;if(typeof persondata=="undefined"){alert("persondata cannot be null");return}window.PersonData=persondata;modalContainer=$("#modalContainer");modalContainer.length>0&&modalContainer.remove();closeCallouts();url="/modals/addfact/tree/"+PersonData.treeId+"/person/"+PersonData.personId;$.ajax({type:"GET",url:url,cache:!1,timeout:2e4,success:function(data){data.result&&$(data.html).modal({width:"410",title:PersonData.menu.facts.addFactTitle,useCustomPadding:!1,onOpen:function(){$("#modal").find(".alertNote").alert(personViewModalAlertSettingsNote).end().find(".alertInfo").alert(personViewModalAlertSettingsInfo).end().find(".alertSuccess").alert(personViewModalAlertSettingsSuccess).end().find(".alert:not(.alertNote):not(.alertInfo):not(.alertSuccess)").alert(personViewModalAlertSettingsWarning);$("#addFactSelect").change(function(){var selectedFactType=$(this).find("option:selected");selectedFactType.hasClass("creatableOption")&&(personAnalyticsTrackClick("addNewFact"+selectedFactType.val()),addNewFact());$("#modalClose").on("click.addFactModalCloseButton",function(){personAnalyticsTrackClick("addFactModalCloseButton")})})},onClose:function(){$(".addModalTriggered").removeClass("addModalTriggered").focus();$("#modalClose").off("click.addFactModal");resetModalContents(!0)}})}})}function addNewFact(newRelationshipPid,saveEventData){var isValidaNewRelationshipPID=typeof newRelationshipPid!="undefined"&&newRelationshipPid.length>0,eventType=$("#addFactSelect").val(),dateFieldVal="",placeFieldVal="",descriptionFieldVal="",modalHeaderTitle="",isPrimary=!1,saveEventDataObj="",isCreateRelationshipEvent=!1,newPersonPid="",url;PersonData.hasAddedNewSpouse=!1;PersonData.newAddedSpouseId="";isValidaNewRelationshipPID&&(isCreateRelationshipEvent=!0,newPersonPid=newRelationshipPid,PersonData.hasAddedNewSpouse=!0,PersonData.newAddedSpouseId=newRelationshipPid);typeof saveEventData!="undefined"&&saveEventData.length>0&&(saveEventDataObj=jQuery.parseJSON(saveEventData),eventType=saveEventDataObj.eventType,dateFieldVal=saveEventDataObj.dateField,placeFieldVal=saveEventDataObj.placeField,descriptionFieldVal=saveEventDataObj.descriptionField,modalHeaderTitle=saveEventDataObj.modalHeaderTitle,isPrimary=!1,saveEventDataObj.isAddNewSpouse==="true"&&(ResetWarningsAndValues(),FactEditModal.isAddNewSpouse=!0));url="/modals/addnewfact/tree/"+PersonData.treeId+"/person/"+PersonData.personId;$("<div>").modal({showLoading:!0,useCustomPadding:!0,onOpen:function($this){$.ajax({type:"GET",url:url,cache:!1,timeout:2e4,data:{eventType:eventType,newPersonPid:newPersonPid},success:function(data){var addPerson,spouseCount,dateField,placeField,descriptionField,$iSpouseSelect,$indvSpouseSelect,locationField,modalEditEvent;data.result&&($.modal.showLoading(!1),$.modal.resize(760),resetModalContents(!0),isValidaNewRelationshipPID&&(addPerson=$("#AddPerson"),addPerson.length>0&&$("#AddPerson").remove()),$this.html(data.html),modalHeaderTitle.length>0?setupModalHeader(modalHeaderTitle):setupModalHeader(data.title),$("#modal").find(".alertNote").alert(personViewModalAlertSettingsNote).end().find(".alertInfo").alert(personViewModalAlertSettingsInfo).end().find(".alertSuccess").alert(personViewModalAlertSettingsSuccess).end().find(".alert:not(.alertNote):not(.alertInfo):not(.alertSuccess)").alert(personViewModalAlertSettingsWarning),setupFactModalUserCard(),$.modal.center(),$("#factEditModalEvent").addClass("tabActive active"),$(".tabContent1").addClass("tabActive active"),spouseCount=parseInt(FactEditModal.person.spouseCount),isRelationshipEventType()&&(isValidaNewRelationshipPID||spouseCount>0)&&(dateField=$(".dateField"),dateField.length>0&&dateField.val(dateFieldVal),placeField=$(".placeField"),placeField.length>0&&placeField.val(placeFieldVal),descriptionField=$(".descriptionField"),descriptionField.length>0&&descriptionField.val(descriptionFieldVal),$iSpouseSelect=$("#individualSpouseSelect"),$iSpouseSelect.is(":visible")?($("#multipleSpouseSelect").is(":visible")&&spouseCount>1?($("#changeSpouseButton").show().attr("onClick","showMultipleSpouseSelect();"),$("#chooseOtherButton").hide()):($("#changeSpouseButton").hide(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();")),$indvSpouseSelect=$iSpouseSelect.find(".existingSpouseIndividual"),$indvSpouseSelect.length>0&&$indvSpouseSelect.addClass("selectedPerson"),$("#multipleSpouseSelect").hide()):($indvSpouseSelect=$iSpouseSelect.find(".existingSpouseIndividual"),$indvSpouseSelect.length>0&&$indvSpouseSelect.removeClass("selectedPerson"),spouseCount<2&&($("#individualSpouseSelect").show(),$("#multipleSpouseSelect").hide()),$("#changeSpouseButton").hide(),$("#chooseOtherButton").show().attr("onClick","showSpouseTypeAheadSection();"))),locationField=$("#location"),locationField.length>0&&factModalInitTypeAhead(PersonData.treeId,locationField),FactEditModal.eventType.toLowerCase()==="birth"||FactEditModal.eventType.toLowerCase()==="death"?$(".card").hasClass("preferredEvent"+FactEditModal.eventType)&&$("#preferredEventCheckbox").show():FactEditModal.eventType.toLowerCase()==="name"&&($("#preferredEventCheckbox").show(),FactEditModal.person.fatherSurname.length>0&&(modalEditEvent=$(".tabContent1"),modalEditEvent.find("#surname").val(FactEditModal.person.fatherSurname))),FactEditModal.eventType==="Gender"?($(".editModalSaveButton").removeAttr("disabled"),setAddNewFactCreateAction()):(FactEditModal.eventType==="Name"?$(".editModalSaveButton").removeAttr("disabled"):(isRelationshipEventType()&&dateFieldVal===""&&placeFieldVal===""&&descriptionFieldVal===""&&$(".editModalSaveButton").attr("disabled","disabled"),setupCreateOrSaveTextButton()),setFactActionWithValidate()),isValidaNewRelationshipPID?FactEditModal.isAddNewSpouse=!0:isRelationshipEventType()&&(setAddNewFactCreateAction(),spouseCount===0&&FactEditModal.isAddNewFact&&($("#chooseOtherButton").hide(),$(".addRelationships").show(),showSpouseTypeAheadSection(),$(".erAddCancel").hide())),setButtonandBannerBasedOnValidation(!1))}})}})}function setAddNewFactCreateAction(){$(".editModalSaveButton").attr("onClick","createNewEvent('tabContent1', 'editModalSaveButton');");$("#factEditModalEvent").attr("onClick","createNewEvent('tabContent1', 'factEditModalEvent');");$("#factEditModalAttachMedia").attr("onClick","createNewEvent('tabContent2', 'factEditModalAttachMedia');");$("#factEditModalSourceCitations").attr("onClick","createNewEvent('tabContent3', 'factEditModalSourceCitations');");$("#factEditModalTimelineOptions").attr("onClick","createNewEvent('tabContent4', 'factEditModalTimelineOptions');")}function setupModalHeader(modalTitle){var factEditModalHeader=$("#factEditModalHeader");factEditModalHeader.length>0?factEditModalHeader.find(".modalTitle").text(modalTitle):($("#modalHeader").length===0&&$("#modalContents").append('<h4 class="modalHeader" id="modalHeader"><\/h4>'),$("#modalHeader").text(modalTitle))}function ResetWarningsAndValues(){var modalEditEvent=$(".tabContent1");modalEditEvent.find(".eventAreaBanner").alert("close");modalEditEvent.find(".eventAreaBannerWarning").alert("close");resetValidationValues();setupCreateOrSaveTextButton()}function resetModalContents(){var loading=$(".loading"),modalContents,modalHeader,modalContainer;loading.length>0&&loading.remove();modalContents=$("#modalContents");modalContents.length>0&&(modalHeader=$("#modalHeader"),modalHeader.length>0&&modalHeader.remove(),modalContainer=$("#modalContainer"),modalContainer.length>0&&modalContainer.remove())}function createNewEvent(selectedContentArea,tabOrButtonItem){var modalEditEvent=$(".tabContent1"),modalEditEventActive=modalEditEvent.hasClass("tabActive"),selectedPerson=modalEditEvent.find(".selectedPerson"),isCreateRelationshipEvent=!1,eventType=FactEditModal.eventType,isPrimary=!1,eventChanged=!1,isFailedSpouseData=!1,dictionary=[],dataExtra,relTypeAheadVal,dateField,$checkBox,url;eventChanged=modalEditEventActive?checkFieldValidation(!0,!0,dictionary):!1;var relationshipEventType=isRelationshipEventType(),relationshipId=typeof selectedPerson!="undefined"&&selectedPerson.length>0&&typeof selectedPerson.attr("data-assertionId")!="undefined"&&selectedPerson.attr("data-assertionId").length>0?selectedPerson.attr("data-assertionId"):"",isFindExistingPerson=!1;if(relationshipEventType&&(relationshipId==="0"||relationshipId.length===0)&&(dataExtra=typeof selectedPerson!="undefined"&&selectedPerson.length>0&&typeof selectedPerson.attr("data-extra")!="undefined"&&selectedPerson.attr("data-extra").length>0?selectedPerson.attr("data-extra"):"",typeof dataExtra!="undefined"&&dataExtra.length>0&&(dataExtra=jQuery.parseJSON(dataExtra)),relationshipId=typeof dataExtra!="undefined"?dataExtra.PID:"",isCreateRelationshipEvent=!0,FactEditModal.originalSpouseId=relationshipId,isFindExistingPerson=!0),relTypeAheadVal="false",relationshipEventType&&relationshipId!=null&&relationshipId!==""&&(relTypeAheadVal=typeof selectedPerson!="undefined"&&selectedPerson.length>0&&typeof selectedPerson.attr("data-isTypeAhead")!="undefined"&&selectedPerson.attr("data-isTypeAhead").length>0?selectedPerson.attr("data-isTypeAhead"):isFindExistingPerson?"true":"false",relTypeAheadVal==="true"&&(isCreateRelationshipEvent=!0),FactEditModal.originalSpouseId=relationshipId),!FactEditModal.hasValidationWarningAgainstSpouseData&&relationshipEventType&&(dateField=modalEditEvent.find(".dateField").val(),typeof dateField!="undefined"&&dateField.length>0&&(eventChanged=validateRelationshipEventAgainstSpouseData(selectedPerson,eventType,dateField,!0,isFailedSpouseData),isFailedSpouseData=!eventChanged,FactEditModal.hasValidationWarningAgainstSpouseData=isFailedSpouseData)),eventChanged){var titleField=typeof dictionary.title!="undefined"?dictionary.title.value:"",dateField=typeof dictionary.date!="undefined"?dictionary.date.value:"",placeField="",placeFieldDataExtra="";typeof dictionary.location!="undefined"&&(placeField=dictionary.location.value,typeof dictionary.location.extra!="undefined"&&(placeFieldDataExtra=dictionary.location.extra));var descriptionField=typeof dictionary.description!="undefined"?dictionary.description.value:"",valueField=typeof dictionary.value!="undefined"?dictionary.value.value:"",givenNameField=typeof dictionary.givenName!="undefined"?dictionary.givenName.value:"",surnameField=typeof dictionary.surname!="undefined"?dictionary.surname.value:"",suffixNameField=typeof dictionary.suffix!="undefined"?dictionary.suffix.value:"",genderTypeField=typeof dictionary.genderMale!="undefined"?"Male":typeof dictionary.genderFemale!="undefined"?"Female":"Unknown";handleButtonsSavingMode();FactEditModal.isPrimary&&(isPrimary=!0);$checkBox=modalEditEvent.find(".isPrimaryCheckbox");$checkBox.length>0&&$checkBox.is(":checked")&&(isPrimary=!0);url="/tree/"+PersonData.treeId+"/person/"+PersonData.personId+"/createnewevent";$.ajax({type:"POST",url:url,cache:!1,timeout:2e4,data:{eventType:eventType,customEventTitle:titleField,date:dateField,place:placeField,description:valueField!=null&&valueField.length>0?valueField:descriptionField,relationshipId:relationshipId,relTypeAhead:relTypeAheadVal,isPrimary:isPrimary,givenName:givenNameField,surname:surnameField,suffixName:suffixNameField,genderType:genderTypeField},success:function(data){var fullname,hasBirth,hasDeath,hasLifeStoryOptions,cancelClose;if(handleButtonsNormalMode(),data.result&&typeof data.assertionId!="undefined"){if(resetModalContents(!1),typeof isPrimary!="undefined"&&isPrimary===!0&&(eventType.toString()==="Birth"||eventType.toString()==="Death"||eventType.toString()==="Name"))if(eventType.toString()==="Name")typeof surnameField!="undefined"&&(fullname=(givenNameField.length>0?givenNameField:"")+(surnameField.length>0?(givenNameField.length>0?" ":"")+surnameField:"")+(suffixNameField.length>0?" "+suffixNameField:""),$("#personCard .userCardTitle").html(fullname),PersonCard.name=fullname,handleFactModalUserCardData(".userCardTitle",fullname));else if(hasBirth=PersonCard.lifeYearRange.indexOf("&ndash;")>0||PersonCard.lifeYearRange.indexOf("-")>0,hasDeath=(PersonCard.lifeYearRange.indexOf("&ndash;")===0||PersonCard.lifeYearRange.indexOf("-")===0)&&PersonCard.lifeYearRange.length>7||PersonCard.lifeYearRange.length>11,!PersonCard.isFamilySearchUser||(hasBirth||eventType.toLowerCase()!=="birth")&&(hasDeath||eventType.toLowerCase()!=="death")){var splitYears=PersonCard.lifeYearRange.indexOf("&ndash;")!==-1?PersonCard.lifeYearRange.split("&ndash;"):PersonCard.lifeYearRange.split("-"),eventResults=validDate(dateField,eventType.toString().toLowerCase(),FactEditModal.person.personBirth,FactEditModal.person.personDeath,FactEditModal.person.motherBirth,FactEditModal.person.motherDeath,FactEditModal.person.fatherBirth,FactEditModal.person.fatherDeath,!1),dateSet="";typeof dateField!="undefined"&&typeof placeField!="undefined"&&eventType.toString()==="Birth"?(window.getPersonCard(),dateSet=(eventResults[0]===0?eventResults[1]:splitYears.length>0&&hasBirth?splitYears[0]:"")+"&ndash;"+(splitYears.length>0&&hasDeath?splitYears.length>1?splitYears[1]:splitYears[0]:""),PersonCard.lifeYearRange=dateSet,dateSet.length>1&&dateSet!=="&ndash;"?handleFactModalUserCardData(".userCardSubTitle","("+dateSet.replace("&ndash;","-")+")"):handleFactModalUserCardData(".userCardSubTitle","")):typeof dateField!="undefined"&&typeof placeField!="undefined"&&eventType.toString()==="Death"&&(window.getPersonCard(),dateSet=(splitYears.length>0&&hasBirth?splitYears[0]:"")+"&ndash;"+(eventResults[0]===0?eventResults[1]:splitYears.length>0&&hasDeath?splitYears.length>1?splitYears[1]:splitYears[0]:""),PersonCard.lifeYearRange=dateSet,dateSet.length>1&&dateSet!=="&ndash;"?handleFactModalUserCardData(".userCardSubTitle","("+dateSet.replace("&ndash;","-")+")"):handleFactModalUserCardData(".userCardSubTitle",""))}else location.reload();tabOrButtonItem!=="editModalSaveButton"&&tabOrButtonItem!=="factEditModalEvent"?(hasLifeStoryOptions=!0,(eventType.toLowerCase()!=="birth"&&eventType.toLowerCase()!=="death"||isPrimary)&&eventType.toLowerCase()!=="name"&&eventType.toLowerCase()!=="gender"||(hasLifeStoryOptions=!1),factEditModal(PersonData.treeId,PersonData.personId,data.assertionId,hasLifeStoryOptions,tabOrButtonItem,selectedContentArea,"","",!0)):$.modal.close();isCreateRelationshipEvent&&showIndividualSpouse();window.glue.reload()}else cancelClose=$(".cancelClose"),cancelClose.length>0&&cancelClose.show(),setButtonandBannerBasedOnValidation(!0)},error:function(xhr,ajaxOptions,thrownError){throwException("status->"+xhr.status+" thrownError->"+thrownError);handleButtonsNormalMode()}})}else setButtonandBannerBasedOnValidation(!0)}function generateNarrativeDataModal(assertionid){var modalNarrative=$(".tabContent4");modalNarrative.addClass("loading").find(".narrativeDataFields").hide();modalNarrative.find(".narrativeField").val("");savePersonNarrativeAndEventDataModal(assertionid,"","",!1)}(function(){window.PersonData||(window.PersonData={})})();typeof personViewModalAlertSettingsNote=="undefined"&&(window.personViewModalAlertSettingsNote={animation:!1,onOpen:function(){$.modal.center()},onClose:function(){$.modal.center()},open:!1,type:"note"},personViewModalAlertSettingsInfo={animation:!1,onOpen:function(){$.modal.center()},onClose:function(){$.modal.center()},open:!1,type:"info"},personViewModalAlertSettingsSuccess={animation:!1,onOpen:function(){$.modal.center()},onClose:function(){$.modal.center()},open:!1,type:"success"},personViewModalAlertSettingsWarning={animation:!1,onOpen:function(){$.modal.center()},onClose:function(){$.modal.center()},open:!1,type:"warning"});
"use strict";function mediaSelectModal(treeId,personId){var url="/modals/mediaselect/tree/"+treeId+"/person/"+personId;$.ajax({type:"GET",url:url,cache:!1,timeout:2e4,success:function(data){$(data).modal({width:"760",onOpen:function(){$("#modalClose").hide()},onClose:function(){mediaSelectUpdate()}})}})}function mediaSelectUpdate(){var IDs=[];$(".mediaSelected").each(function(){IDs.push(this.id)})}function toggleShowFamilyEvents(treeId,personId){toggleStoryCheckedMenuItem("#storyFamilyEvents");var toggleUrl="/tree/"+treeId+"/person/"+personId+"/tab/lifestory/toggleShowFamilyEvents";$.ajax({url:toggleUrl,method:"GET",cache:!1,success:function(){window.glue.reload()}})}function toggleShowHistoricalInsights(treeId,personId){toggleStoryCheckedMenuItem("#storyHistoricalInsights");var toggleUrl="/tree/"+treeId+"/person/"+personId+"/tab/lifestory/toggleShowHistoricalInsights";$.ajax({url:toggleUrl,method:"GET",cache:!1,success:function(){window.glue.reload()}})}function toggleStoryCheckedMenuItem(idVal){var storyMenuItem=$(idVal);storyMenuItem.hasClass("calloutMenuChecked")?(storyMenuItem.removeClass("calloutMenuChecked"),storyMenuItem.addClass("calloutMenuUnchecked loading loadingSmall loadingOnBlack")):(storyMenuItem.removeClass("calloutMenuUnchecked"),storyMenuItem.addClass("calloutMenuChecked loading loadingSmall loadingOnBlack"));storyMenuItem.closest(".lifeStoryOptionsMenu").addClass("lifeStoryOptionsMenuDisabled")}$(function(){var tabPressed=!1,tabShiftPressed=!1,enterPressed=!1,narrativeSelected=!1;$(".lifeStoryNarrative").on("click",".editButton",function(){var $this=$(this),$narrativeSection=$this.closest(".lifeStoryNarrative"),$narrText;closeCallouts();$narrativeSection.addClass("lifeStoryNarrativeEditing");$narrText=$narrativeSection.find(".narrativeText");$narrText.attr({contenteditable:"true",spellcheck:"false"});$(".timelineItem").addClass("timelineItemEditingDisabled");$narrText.focus()}).on("click",".closeNarEditing",function(){var $this=$(this),narrativeSection=$this.closest(".lifeStoryNarrative"),selection=window.getSelection?window.getSelection():document.selection?document.selection:null,narrativeData,narrativeOriginalText;$this.hasClass("closeNarEditingCancel")&&(!selection||(selection.empty?selection.empty():selection.removeAllRanges()),$(".lifeStoryNarrative").removeClass("lifeStoryNarrativeEditing").find(".narrativeText").removeAttr("contenteditable spellcheck"),$(".timelineItem").removeClass("timelineItemEditingDisabled"),narrativeSection.focus(),narrativeData=$(".narrativeText"),narrativeData.length>0&&(narrativeOriginalText=narrativeData.attr("data-narrative-original"),(narrativeData.text().length!==narrativeOriginalText.length||narrativeData.text().toString()!=narrativeOriginalText.toString())&&narrativeData.text(narrativeOriginalText)))}).on("click",".addLifeStory",function(){$(this).closest(".lifeStoryNarrative").find(".editButton").trigger("click")}).on("mousedown",".narrativeText",function(){tabPressed=!1;tabShiftPressed=!1;narrativeSelected=!1}).on("focus",".narrativeText",function(){if(tabPressed||tabShiftPressed){var el=this,range=document.createRange(),sel=window.getSelection();range.selectNodeContents(el);sel.removeAllRanges();sel.addRange(range)}else tabPressed=!1,tabShiftPressed=!1}).on("keydown",".narrativeText, .closeNarEditing",function(event){tabPressed=tabShiftPressed=enterPressed=!1;event.which===9&&event.shiftKey&&(tabShiftPressed=!0);event.which!==9||event.shiftKey||(tabPressed=!0);event.which===13&&(enterPressed=!0)}).on("keyup",".narrativeText",function(){var $this=$(this);$this.text()===""&&$this.empty()}).on("blur",".narrativeText",function(event){var $this=$(this),narrativeSection=$this.closest(".lifeStoryNarrative"),selection=window.getSelection?window.getSelection():document.selection?document.selection:null;return event.preventDefault(),!selection||(selection.empty?selection.empty():selection.removeAllRanges()),window.personScreenType("smart-phone")&&tabShiftPressed&&narrativeSection.find(".closeNarEditingCancel").focus(),!window.personScreenType("smart-phone")&&tabPressed&&narrativeSection.find(".closeNarEditingCancel").focus(),!window.personScreenType("smart-phone")&&tabShiftPressed&&narrativeSection.find(".closeNarEditingSave").focus(),!1}).on("blur",".closeNarEditingCancel",function(){var $this=$(this),narrativeSection=$this.closest(".lifeStoryNarrative");return window.personScreenType("smart-phone")&&tabPressed?(narrativeSection.find(".narrativeText").focus(),!1):!window.personScreenType("smart-phone")&&tabShiftPressed?(narrativeSection.find(".narrativeText").focus(),!1):void 0});PersonStory.showGuidance&&$(".personPageStory .guidanceModalTrigger").click()});
"use strict";function storyItemInitTypeAhead(locationField){var treeId=$(".treeId").val();locationField.autocomplete({source:"/suggest/place?treeId="+treeId+"&tad=none",key:"placeName",queryParameter:"term",dataType:"json",minLength:3,maxResults:12,customDisplay:function(data){return{value:data.value,display:data.display}},onItemSelect:function(){},onOpen:!1,onClose:!1})}function ignoreHistoricalInsight(historicalInsightId){var ignoreUrl="/tree/"+PersonCard.treeId+"/person/"+PersonCard.personId+"/historicalinsightid/"+historicalInsightId+"/ignoreHistoricalInsight";$.ajax({url:ignoreUrl,method:"GET",success:function(data){if(data.result){var historicalInsight=$("."+historicalInsightId);$("html").data({"saved-event-id":historicalInsightId,"saved-scroll-top":historicalInsight.offset().top,"saved-event-rect-top":historicalInsight[0].getBoundingClientRect().top});window.glue.reload()}}})}function savePersonLifestoryNarrative(){var lifeStoryNarrative=$(".lifeStoryNarrative"),narrativeText=lifeStoryNarrative.find(".narrativeText"),lifeStoryNarrativeText=narrativeText.text(),narrativeOriginalTextTemp=narrativeText.attr("data-narrative-original"),url;if(lifeStoryNarrativeText===narrativeOriginalTextTemp){$(".closeNarEditingCancel").trigger("click");return}narrativeText.length>0&&narrativeText.attr("data-narrative-original",lifeStoryNarrativeText);url="/tree/"+PersonCard.treeId+"/person/"+PersonCard.personId+"/savepersonlifestorynarrative";$.ajax({type:"POST",url:url,cache:!1,timeout:2e4,data:{narrative:lifeStoryNarrativeText},success:function(data){if(data.result){if(data.eventNarrative!=null){var lifeStoryNarrativeData=narrativeText.attr("data-narrative-original");lifeStoryNarrativeText.length===0?window.location.reload():lifeStoryNarrativeText.length!==lifeStoryNarrativeData&&window.glue.reload()}}else acom!=null&&acom.bus!=null&&typeof PersonStory!="undefined"&&acom.bus.emit("LifeStory::Notify::Failure",PersonStory.narrative.updateError,"",!0)},error:function(){narrativeText.attr("data-narrative-original",narrativeOriginalTextTemp);acom!=null&&acom.bus!=null&&typeof PersonStory!="undefined"&&acom.bus.emit("LifeStory::Notify::Failure",PersonStory.narrative.updateError,"",!0)}})}function savePersonNarrativeAndEventData(assertionid){var storyItem=$("."+assertionid),eventChanged=!1,narrativeChanged=!1,eventType=storyItem.find(".eventType").val(),dateField=storyItem.find("#"+assertionid+"DateField").val(),placeField=storyItem.find("#"+assertionid+"LocationField").val(),placeFieldDataExtra=storyItem.find("#"+assertionid+"LocationField").attr("data-extra"),descriptionField=storyItem.find(".storyDesc").text(),relationshipId=storyItem.find(".relationshipId").val(),originalDateVal=storyItem.find("#"+assertionid+"DateField").attr("data-placeholder"),originalPlaceVal=storyItem.find("#"+assertionid+"LocationField").attr("data-placeholder"),originalDescriptionVal=storyItem.find(".storyDesc").attr("data-placeholder"),placeGpid="",saveValue,url;typeof placeFieldDataExtra!="undefined"&&placeFieldDataExtra.length>0&&$.each($.parseJSON(placeFieldDataExtra),function(key,value){key==="GPID"&&(placeGpid=value)});(typeof originalDateVal!="undefined"&&typeof dateField!="undefined"&&originalDateVal!==dateField||typeof originalPlaceVal!="undefined"&&typeof placeField!="undefined"&&originalPlaceVal!==placeField||typeof originalDescriptionVal!="undefined"&&typeof descriptionField!="undefined"&&originalDescriptionVal!==descriptionField)&&(eventChanged=!0);var narrativeTitleField=storyItem.find(".storyType").text(),originalNarrativeTitleVal=storyItem.find(".storyType").attr("data-placeholder"),narrativeField=storyItem.find(".storyNarr").text(),originalNarrativeVal=storyItem.find(".storyNarr").attr("data-placeholder"),timelineItemHidden=storyItem.hasClass("timelineItemHiding"),timelineItemMapVisible=storyItem.hasClass("timelineItemMapVisible")&&storyItem.hasClass("timelineItemHasMap"),timelineItemMapVisibleOriginal=storyItem.find(".narrIsMapOn").val(),timelineItemImageVisible=storyItem.hasClass("timelineItemImageVisible"),timelineItemImageVisibleOriginal=storyItem.find(".narrIsMediaOn").val();(timelineItemHidden||typeof originalNarrativeTitleVal!="undefined"&&typeof narrativeTitleField!="undefined"&&originalNarrativeTitleVal!==narrativeTitleField||typeof originalNarrativeVal!="undefined"&&typeof narrativeField!="undefined"&&originalNarrativeVal!==narrativeField||typeof timelineItemMapVisible!="undefined"&&typeof timelineItemMapVisibleOriginal!="undefined"&&timelineItemMapVisible.toString()!==timelineItemMapVisibleOriginal.toString().toLowerCase()||timelineItemImageVisible.toString()!==timelineItemImageVisibleOriginal.toString().toLowerCase())&&(narrativeChanged=!0);saveValue="";eventChanged&&narrativeChanged?saveValue="0":eventChanged?saveValue="1":narrativeChanged&&(saveValue="2");saveValue.length>0&&(eventChanged||narrativeChanged)?(PersonStory.map.useMapModal&&$('[id^="mapJSONNarrativeModal"]').length>0&&$('[id^="mapJSONNarrativeModal"]').remove(),url="/tree/"+PersonCard.treeId+"/person/"+PersonCard.personId+"/assertionid/"+assertionid+"/savepersonnarrativeandeventdata",$.ajax({type:"POST",url:url,cache:!1,timeout:2e4,data:{saveContentValue:saveValue,title:narrativeTitleField,narrative:narrativeField,isHidden:timelineItemHidden,isMapOn:timelineItemMapVisible,isImageOn:timelineItemImageVisible,preferredImageId:storyItem.find(".storyPreferredImageId").val(),eventId:storyItem.find(".eventId").val(),eventType:eventType,date:dateField,place:placeField,placeGpid:placeGpid,description:descriptionField,relationshipId:relationshipId},success:function(data){data.result?storyItem.data("refresh")=="1"?location.reload():($("html").data({"saved-event-id":assertionid,"saved-scroll-top":storyItem.offset().top,"saved-event-rect-top":storyItem[0].getBoundingClientRect().top}),window.glue.reload()):acom!=null&&acom.bus!=null&&typeof PersonStory!="undefined"&&acom.bus.emit("LifeStory::Notify::Failure",PersonStory.narrative.updateError,"",!0)},error:function(){acom!=null&&acom.bus!=null&&typeof PersonStory!="undefined"&&acom.bus.emit("LifeStory::Notify::Failure",PersonStory.narrative.updateError,"",!0)}}),cancelEdit=!1):cancelEdit=!0}function getTimlineEventMapData(assertionid,hasMap){var storyItem=$("."+assertionid),mediaFigureMap=storyItem.find(".mediaFigureMap"),url;hasMap||mediaFigureMap.length!==0||storyItem.find(".addMediaDivMap").after('<figure class="mediaFigure mediaFigureMap"><div id="figureMap'+assertionid+'"><div class="mapJSON" id="mapJSONNarrative'+assertionid+'"><div id="map-ui'+assertionid+'" class="map-ui"><a id="mapLink'+assertionid+'" class="leaflet-control-mapbox-geocoder-toggle mapbox-icon mapbox-icon-geocoder" href="#"><\/a><\/div><\/div><\/div><\/figure>');url="/tree/"+PersonCard.treeId+"/person/"+PersonCard.personId+"/assertionid/"+assertionid+"/getpersonlifestoryeventmapdata";$.ajax({type:"GET",url:url,cache:!1,timeout:2e4,success:function(data){if(data.result&&data.EventMapMapData!=null)if(hasMap)if(mediaFigureMap.length>0){var figureMap=mediaFigureMap.children(":first").attr("id"),mapId=figureMap.substring(9,figureMap.length);individualEventMapsInitializeStatic(mapId,data.EventMapMapData);eventMapsInitializeSetData(mapId,data.EventMapMapData);$("#mapJSONNarrativeModalTemp"+mapId).hide()}else individualEventMapsInitializeStatic(assertionid,data.EventMapMapData),eventMapsInitializeSetData(assertionid,data.EventMapMapData),$("#mapJSONNarrativeModalTemp"+assertionid).hide();else storyItem.find(".storyCuration").find(".toggleMap").removeAttr("onclick"),individualEventMapsInitializeStatic(assertionid,data.EventMapMapData),eventMapsInitializeSetData(assertionid,data.EventMapMapData),$("#mapJSONNarrativeModalTemp"+assertionid).hide()}})}var cancelEdit=!1;$(function(){$("html").data("saved-event-id")&&($("."+$("html").data("saved-event-id")).length>0?($("html, body").scrollTop($("."+$("html").data("saved-event-id")).offset().top-$("html").data("saved-event-rect-top")),$("."+$("html").data("saved-event-id")).focus()):$("html, body").scrollTop($("html").data("saved-scroll-top")-$("html").data("saved-event-rect-top")),$("html").removeData("saved-event-id").removeData("saved-scroll-top").removeData("saved-event-rect-top"));var tabPressed=!1,tabShiftPressed=!1,enterPressed=!1,contentEditableSelected=!1,isAddMapSaved=!1;$(".timelineItem:first").hasClass("needsTimeline")||$(".lifeStorySec.lifeStoryMap").addClass("noTimeline");$("ul.timelineList").on("click",".newEditButton",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem"),mediaItems=timelineItem.find(".mediaItem"),timelineItemCurClasses=timelineItem.attr("class"),mediaItemCurClasses=mediaItems.attr("class"),eventId=timelineItem.find(".eventId");closeCallouts();newFactEditModal(window.PersonStory.personData,eventId.val(),!0,"","",!1)}).on("click",".editButton",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem"),mediaItems=timelineItem.find(".mediaItem"),timelineItemCurClasses=timelineItem.attr("class"),mediaItemCurClasses=mediaItems.attr("class"),eventId=timelineItem.find(".eventId"),locationField;closeCallouts();$(".lifeStoryNarrative").addClass("lifeStoryNarrativeDisabled");timelineItem.addClass("timelineItemEditing").data("timelineclasses",timelineItemCurClasses).siblings(".timelineItem").addClass("timelineItemEditingDisabled");timelineItem.hasClass("Media")?timelineItem.addClass("bgDark").find(".storyCuration button").removeAttr("tabindex"):timelineItem.find(".storyCuration button, .targetPerson").addClass("bgDark").removeAttr("tabindex");timelineItem.find(".textEditable").attr({contenteditable:"true",spellcheck:"false"});timelineItem.find(".textEditable[data-placeholder-empty]").each(function(){var $this=$(this);$this.text()===""&&$this.empty()});mediaItems.each(function(){var $this=$(this);$this.attr("data-mediaclasses",mediaItemCurClasses)});timelineItem.focus();eventId.length>0&&(locationField=$("#"+eventId.val()+"LocationField"),locationField.length>0&&storyItemInitTypeAhead(locationField))}).on("click",".timelineItemEditing .closeCuration",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem"),mediaItems=timelineItem.find(".mediaItem"),timelineItemStoredClasses=timelineItem.data("timelineclasses"),mediaItemStoredClasses=mediaItems.data("mediaclasses"),selection=window.getSelection?window.getSelection():document.selection?document.selection:null;($this.hasClass("closeCurationCancel")||window.cancelEdit)&&(closeCallouts(),$(".lifeStoryNarrative").removeClass("lifeStoryNarrativeDisabled"),timelineItem.removeClass("timelineItemEditing bgDark").siblings(".timelineItem").removeClass("timelineItemEditingDisabled"),timelineItem.find(".storyCuration button, .targetPerson").removeClass("bgDark"),timelineItem.find(".storyCuration button").attr("tabindex","-1"),timelineItem.hasClass("HistoricalInsight")||timelineItem.find(".textEditable").removeAttr("contenteditable spellcheck"),!selection||(selection.empty?selection.empty():selection.removeAllRanges()),timelineItem.focus(),timelineItem.attr("class",timelineItemStoredClasses),isAddMapSaved&&(timelineItem.removeClass("timelineItemNoMap").addClass("timelineItemHasMap"),timelineItem.hasClass("timelineItemMapHidden")&&timelineItem.removeClass("timelineItemMapHidden").addClass("timelineItemMapVisible")),isAddMapSaved||timelineItem.hasClass("HistoricalInsight")||(timelineItem.find(".textEditable").each(function(){var $this=$(this);$this.html($this.attr("data-placeholder"))}),timelineItem.find(".editableDateField").val(timelineItem.find(".editableDateField").attr("data-placeholder")),timelineItem.find(".editableLocationField").val(timelineItem.find(".editableLocationField").attr("data-placeholder")),mediaItems.each(function(){var $this=$(this);$this.attr("class",mediaItemStoredClasses)})))}).on("click",".timelineItemEditing .addMediaPhoto",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");closeCallouts()}).on("click",".timelineItemEditing .addMediaMap",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem"),locationField,storyNarrText,assertionid;closeCallouts();locationField=$("#"+timelineItem.find(".eventId").val()+"LocationField");typeof locationField!="undefined"&&locationField.length>0&&locationField.val().length===0?($this.callout({style:"dark",type:"click",classes:"bgDark calloutStyleDark",content:PersonStory.map.addPlaceToSeeMap}),$this.callout("open")):typeof locationField!="undefined"&&locationField.length>0&&locationField.val().length>0&&($this.callout("destroy"),isAddMapSaved=!0,timelineItem.removeClass("timelineItemNoMap").addClass("timelineItemHasMap"),timelineItem.hasClass("timelineItemMapHidden")&&timelineItem.removeClass("timelineItemMapHidden").addClass("timelineItemMapVisible"),storyNarrText=timelineItem.find(".storyNarr").text(),assertionid=timelineItem.find(".eventId").val(),savePersonNarrativeAndEventData(assertionid,!1),timelineItem.find(".narrIsMapOn").val("True"),timelineItem.find(".storyNarr").text(storyNarrText))}).on("click",".timelineItemEditing .toggleMap",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");closeCallouts();timelineItem.hasClass("timelineItemMapHidden")?(personAnalyticsTrackClick("lifeStoryItemShowMap"),timelineItem.removeClass("timelineItemMapHidden").addClass("timelineItemMapVisible")):(personAnalyticsTrackClick("lifeStoryItemHideMap"),timelineItem.removeClass("timelineItemMapVisible").addClass("timelineItemMapHidden"))}).on("click",".timelineItemEditing .toggleMedia",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");closeCallouts();timelineItem.hasClass("timelineItemImageHidden")?(personAnalyticsTrackClick("lifeStoryItemShowMedia"),timelineItem.removeClass("timelineItemImageHidden").addClass("timelineItemImageVisible")):(personAnalyticsTrackClick("lifeStoryItemHideMedia"),timelineItem.removeClass("timelineItemImageVisible").addClass("timelineItemImageHidden"))}).on("click",".timelineItemEditing .closeBtn",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem"),mediaItem=$this.closest(".mediaItem");mediaItem.removeClass("mediaItemVisible").addClass(" mediaItemHidden");mediaItem.siblings().hasClass("mediaItemVisible")||timelineItem.toggleClass("timelineItemNoImage timelineItemHasImage timelineItemImageVisible timelineItemImageHidden")}).on("click",".timelineItemEditing .histEpButtonConfirm",function(){clearNarrativeCache()}).on("click",".timelineItemEditing .hidingEvent",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");closeCallouts();timelineItem.toggleClass("timelineItemHiding").focus()}).on("blur",".timelineItemEditing [contenteditable]",function(){var $this=$(this),contentEditableValue=$this.text();$this.empty().text(contentEditableValue)}).on("blur",".timelineItemEditing .editableLocationField",function(){!window.personScreenType("smart-phone")&&tabPressed&&$(this).attr("disabled","disabled").removeAttr("disabled").closest(".timelineItem").find(".storyCuration button:visible:first").focus()}).on("blur keyup mouseup",".timelineItemEditing [data-placeholder-empty]",function(){var $this=$(this);$this.text()===""&&$this.empty()}).on("blur keyup mouseup",".timelineItemEditing [data-max]",function(e){var $this=$(this),$text=$this.text(),$max=$this.attr("data-max"),limitText=function(ev){if($text.length>=$max){ev.preventDefault();$this.text($text.substr(0,$max-1));var range=document.createRange(),sel=window.getSelection();range.setStart($this.get(0),1);range.collapse(!0);sel.removeAllRanges();sel.addRange(range);$this.focus()}return!0};e.which===17?setTimeout(function(){$text=$this.text();limitText(e)},250):limitText(e)}).on("blur",".timelineItemEditing .mediaList > li:last-child .photoOverlayButton",function(event){var $this=$(this),timelineItem=$this.closest(".timelineItem");if(tabPressed&&(timelineItem.hasClass("Media")||timelineItem.hasClass("HistoricalInsight")))return event.preventDefault(),window.personScreenType("smart-phone")?timelineItem.find(".storyContentFooter .closeCurationCancel").focus():timelineItem.find(".storyCuration .closeCurationCancel").focus(),!1}).on("blur",".timelineItemEditing .curationDiv button:visible:first",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");return!window.personScreenType("smart-phone")&&tabShiftPressed?(timelineItem.hasClass("Media")||timelineItem.hasClass("HistoricalInsight")?timelineItem.find(".mediaList > li:last-child .photoOverlayButton").focus():timelineItem.find(".editableLocationField").focus(),!1):window.personScreenType("smart-phone")&&tabShiftPressed?(timelineItem.find(".storyContentFooter .closeCurationCancel").focus(),!1):void 0}).on("blur",".timelineItemEditing.Media .mediaList > li:first-child .photo",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");!window.personScreenType("smart-phone")&&tabShiftPressed&&timelineItem.find(".storyContentFooter .closeCurationCancel").focus()}).on("blur",".timelineItemEditing .storyContentFooter button:visible:last",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");if(tabPressed)return timelineItem.hasClass("Media")?timelineItem.find(".photo").focus():timelineItem.hasClass("timelineItemHiding")?timelineItem.find(".storyContentFooter button:visible:first").focus():timelineItem.find(".storyCuration button:visible:first").focus(),!1}).on("blur",".timelineItemHiding .storyContentFooter button:visible:first",function(){if(tabShiftPressed)return $(this).closest(".timelineItem").find(".hidingEventButton").focus(),!1}).on("focus",".timelineItemEditing [contenteditable]",function(){if(contentEditableSelected=!0,tabPressed||tabShiftPressed){var el=this,range=document.createRange(),selection=window.getSelection?window.getSelection():document.selection?document.selection:null;range.selectNodeContents(el);selection.removeAllRanges();selection.addRange(range)}else tabPressed=!1,tabShiftPressed=!1;contentEditableSelected=!1}).on("mousedown",".timelineItemEditing [contenteditable], .timelineItemEditing .editableLocationField",function(){tabPressed=!1;tabShiftPressed=!1;enterPressed=!1;contentEditableSelected===!0&&(contentEditableSelected=!1)}).on("keydown",".timelineItemEditing .ancBtn, .timelineItemEditing .link, .timelineItemEditing [contenteditable], .timelineItemEditing .editableLocationField",function(event){tabPressed=tabShiftPressed=enterPressed=!1;event.which===9&&event.shiftKey&&(tabShiftPressed=!0);event.which!==9||event.shiftKey||(tabPressed=!0);event.which===13&&(enterPressed=!0)}).on("keydown",".timelineItemEditing [contenteditable]",function(){if(contentEditableSelected!==!1){var selection=window.getSelection?window.getSelection():document.selection?document.selection:null;!selection||(selection.empty?selection.empty():selection.removeAllRanges())}})});
"use strict";function initializeLifeStoryMenuOptionsCallout(){$(".lifeStoryOptions .menuButtonOptions").callout({type:"click",classes:"calloutMenu calloutLifeStoryOptions",content:"#lifeStoryOptionsCalloutDomContent",style:"dark"});$(".calloutContent").hasClass("calloutLifeStoryOptions")&&(window.personScreenType("smart-phone")?$(".lifeStoryOptions .menuButtonOptions.show480").callout("close").callout("open"):$(".lifeStoryOptions .menuButtonOptions.hide480").callout("close").callout("open"))}function initializeMapbox(){(PersonStory.map.lifeEvents.show||PersonStory.map.count>0)&&($("head").append($("<link rel='stylesheet' href='//api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.css' type='text/css' />")),$.cachedScript("//api.tiles.mapbox.com/mapbox.js/plugins/geo-viewport/v0.1.1/geo-viewport.js").done(function(){$.cachedScript("//api.tiles.mapbox.com/mapbox.js/plugins/geojson-extent/v0.0.1/geojson-extent.js").done(function(){$.cachedScript("//api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.js").done(function(){$.cachedScript("//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js").done(function(){PersonStory.map.lifeEvents.show&&lifeEventsMapInitializeStatic();PersonStory.map.count>0&&eventMapsInitializeStatic()})})})}))}function findAPersonInitTypeAhead(personField){var excludepids=personField.data("autocomplete-excludepids"),treeId=PersonCard.treeId;personField.autocomplete({source:"/suggest/person?treeId="+treeId+"&serviceDown=none&excludePids="+excludepids,key:"name",queryParameter:"term",dataType:"json",minLength:3,maxResults:20,customDisplay:function(data){return{value:data.value,display:data.display}},onItemSelect:function(itemData){itemData!==""&&itemData.PID!=""&&setFindPersonTypeAheadFields(itemData.PID)},onOpen:!1,onClose:!1})}function setFindPersonTypeAheadFields(personId){var goToPerson=$("#hidableFindAPersonGoToPerson"),pageUrl,personIndex,clearPerson;goToPerson.length>0&&(pageUrl=window.location.toString(),personIndex=pageUrl.indexOf(PersonCard.treeId+"/person"),pageUrl=pageUrl.substring(0,personIndex),goToPerson.attr("onclick",'javascript:$(location).attr("href","'+pageUrl+PersonCard.treeId+"/person/"+personId+'");'),goToPerson.removeAttr("disabled"));clearPerson=$("#hidableFindAPersonClearSelection");clearPerson.length>0&&(clearPerson.attr("onclick","javascript:$('#hidableFindAPerson').val('');$('#hidableFindAPersonGoToPerson').removeAttr('onclick');$('#hidableFindAPersonGoToPerson').attr('disabled','disabled');$('#hidableFindAPersonClearSelection').attr('disabled','disabled');findAPersonInitTypeAhead($('#hidableFindAPerson'));"),clearPerson.removeAttr("disabled"))}function deleteEventModal(){$('<div class="form"><p>$$Are you sure you want to permanently delete this event from your timeline?<\/p><footer class="modalSection"><div class="ancGrid"><div class="ancCol"><button class="ancBtn lrg closeModal" onClick="hideEventFromTimeline();" type="button">$$Delete<\/button><\/div><div class="ancCol"><button class="ancBtn silver lrg closeModal" type="button">'+PersonStory.text.cancelUpper+"<\/button><\/div><\/div><\/footer><\/div>").modal({width:"410",title:PersonCard.text.deleteEvent})}function getLatLongDifferenceValues(LongLatList){for(var latDiff,longDiff,prevLat=0,prevLong=0,latDiffVal=0,longDiffVal=0,latLongDiffArr=[],differentPlacesCnt=0,m=0;m<LongLatList.length;m++)latDiff=Math.abs(Math.abs(LongLatList[m].Latitude)-prevLat),longDiff=Math.abs(Math.abs(LongLatList[m].Longitude)-prevLong),latDiff>1.75&&(latDiffVal=latDiff),longDiff>1.75&&(longDiffVal=longDiff),prevLat=Math.abs(LongLatList[m].Latitude),prevLong=Math.abs(LongLatList[m].Longitude),(longDiff>1||latDiff>1)&&differentPlacesCnt++;return latLongDiffArr[0]=latDiffVal,latLongDiffArr[1]=longDiffVal,latLongDiffArr[2]=differentPlacesCnt,latLongDiffArr}function showLifeEventsMapModal(){var modalContents=$("#modalContents"),mapLifeEventsModal;modalContents.length>0&&(mapLifeEventsModal=modalContents.find("#mapLifeEventsModal"),mapLifeEventsModal.length>0&&mapLifeEventsModal.remove());lifeEventsMapInitialize();$("#mapLifeEventsModal").modal({showLoading:!0,useCustomPadding:!0,title:"",width:"100%",onClose:function(){$(".photoOverlayButton.active").removeClass("active").closest("figure").focus()}})}function lifeMapsZoomLevelEnhance(latDiffVal,longDiffVal,lifeEventsMapDataZoomLevel){return lifeEventsMapDataZoomLevel>7?latDiffVal<4&&latDiffVal>2||longDiffVal<4&&longDiffVal>2?6:latDiffVal<2||longDiffVal<2?longDiffVal>20?6:7:latDiffVal>4&&longDiffVal>5.5&&lifeEventsMapDataZoomLevel===8?latDiffVal<20&&longDiffVal<30?lifeEventsMapDataZoomLevel-4:latDiffVal<36&&longDiffVal<100?lifeEventsMapDataZoomLevel-3:latDiffVal<50&&longDiffVal<110?lifeEventsMapDataZoomLevel-1:lifeEventsMapDataZoomLevel:latDiffVal>4&&longDiffVal>2&&lifeEventsMapDataZoomLevel>6&&lifeEventsMapDataZoomLevel!==9?lifeEventsMapDataZoomLevel-2:latDiffVal<40&&longDiffVal>110&&lifeEventsMapDataZoomLevel===9?lifeEventsMapDataZoomLevel:7:lifeEventsMapDataZoomLevel===2||lifeEventsMapDataZoomLevel===3?latDiffVal>4&&latDiffVal<9&&longDiffVal>4&&longDiffVal<40&&lifeEventsMapDataZoomLevel===2?3:latDiffVal<3.2&&longDiffVal>2&&longDiffVal<15&&lifeEventsMapDataZoomLevel===3?4:latDiffVal>4&&latDiffVal<60&&longDiffVal>4&&longDiffVal<60&&lifeEventsMapDataZoomLevel===3?lifeEventsMapDataZoomLevel-1:lifeEventsMapDataZoomLevel:latDiffVal<4&&latDiffVal>2||longDiffVal<4&&longDiffVal>2?lifeEventsMapDataZoomLevel>6?latDiffVal>4&&latDiffVal<5.5&&longDiffVal>2&&longDiffVal<3||latDiffVal<4&&longDiffVal<25&&lifeEventsMapDataZoomLevel===7?lifeEventsMapDataZoomLevel-2:lifeEventsMapDataZoomLevel-1:latDiffVal<4&&longDiffVal>2&&longDiffVal<36&&lifeEventsMapDataZoomLevel===5?lifeEventsMapDataZoomLevel-1:lifeEventsMapDataZoomLevel:latDiffVal>8&&latDiffVal<16&&longDiffVal>10&&longDiffVal<25&&lifeEventsMapDataZoomLevel>6?lifeEventsMapDataZoomLevel-3:latDiffVal>4&&longDiffVal>2&&lifeEventsMapDataZoomLevel>6?latDiffVal<8&&longDiffVal<25?lifeEventsMapDataZoomLevel-3:lifeEventsMapDataZoomLevel-2:(latDiffVal<2&&longDiffVal>4&&longDiffVal<36||latDiffVal>4&&longDiffVal>4&&longDiffVal<22||latDiffVal<6&&longDiffVal<44||latDiffVal>35&&latDiffVal<40&&longDiffVal>40&&longDiffVal<44)&&lifeEventsMapDataZoomLevel===4?lifeEventsMapDataZoomLevel:latDiffVal<21&&latDiffVal>4&&longDiffVal>2&&longDiffVal<36&&lifeEventsMapDataZoomLevel===5?lifeEventsMapDataZoomLevel-2:lifeEventsMapDataZoomLevel-1}function lifeEventsMapInitialize(){var isUseMapModal,lifeEventsMapData,heightVal,geoJson;if(PersonStory.map.lifeEvents.data!==null){if(isUseMapModal=typeof PersonStory.map.useMapModal!="undefined"&&PersonStory.map.useMapModal!==null&&PersonStory.map.useMapModal.length>0&&PersonStory.map.useMapModal==="true",isUseMapModal||$(".mapFigure .photoOverlayButton").hide(),lifeEventsMapData=PersonStory.map.lifeEvents.data[0],isUseMapModal||($(".mapFigure .photoOverlayButton").hide(),$("#static-map").hide(),$("#mapLifeEvents").show()),isUseMapModal&&$("#mapLifeEventsModalTemp").length>0&&($("#mapLifeEventsModalTemp").remove(),typeof PersonStory.map.lifeMapObject!="undefined"&&PersonStory.map.lifeMapObject!==null&&(PersonStory.map.lifeMapObject.remove(),PersonStory.map.lifeMapObject=null)),isUseMapModal&&(heightVal=$(window).height()-40,$("#mapLifeEventsModalTemp").length&&$("#mapLifeEventsModalTemp").length!==0||$('<div id="mapLifeEventsModalTemp"><div id="mapLifeEventsModal" style="height:'+heightVal+'px;" /><\/div>').appendTo("body"),$("#mapLifeEventsModal").html("")),typeof L!="undefined"&&(typeof PersonStory.map.lifeMapObject=="undefined"||PersonStory.map.lifeMapObject===null)){var mapLE=L.mapbox.map(isUseMapModal?"mapLifeEventsModal":"mapLifeEvents",PersonStory.map.account+"."+PersonStory.map.handle,{zoomControl:!0,tileLayer:{format:"jpg70",noWrap:isUseMapModal?!1:!0,minZoom:2,maxZoom:13}}),latLongDiffArr=getLatLongDifferenceValues(lifeEventsMapData.LongLatList),latDiffVal=latLongDiffArr[0],longDiffVal=latLongDiffArr[1],zoomLevel=latLongDiffArr[2]===1&&lifeEventsMapData.ZoomLevel>=7?lifeEventsMapData.ZoomLevel:lifeMapsZoomLevelEnhance(latDiffVal,longDiffVal,lifeEventsMapData.ZoomLevel);window.personScreenType("not-large-screen")&&zoomLevel>2?zoomLevel-=1:zoomLevel<=2&&(zoomLevel+=1);mapLE.setView([lifeEventsMapData.CenterLatitude,lifeEventsMapData.CenterLongitude],zoomLevel);mapLE.options.maxBounds=mapLE.getBounds();isUseMapModal||(mapLE.scrollWheelZoom.disable(),$("#mapLink").attr("href","javascript:window.open('"+lifeEventsMapData.MapUrl+"', 'toolbar=no, scrollbars=no, resizable=no, width=800, height=800');void(0);"));geoJson={type:"FeatureCollection",features:parseLongLatVals(lifeEventsMapData.LongLatList)};mapLE.featureLayer.on("layeradd",function(e){var marker=e.layer,feature=marker.feature,popupContent='<div style="max-width:220px;"><b>'+feature.properties.details+"<\/b><\/div>";marker.bindPopup(popupContent,{closeButton:!1,maxWidth:220,minWidth:100})});mapLE.featureLayer.setGeoJSON(geoJson);mapLE.on("mousedown",function(){personAnalyticsTrackClick("lifeEventMapClick")});mapLE.featureLayer.on("mouseover",function(e){e.layer.openPopup()}).on("mouseout",function(e){e.layer.closePopup()}).on("click",function(e){personAnalyticsTrackClick("lifeEventMapPinClick"+e.layer.feature.properties["marker-type"]);mapLE.panTo(e.layer.getLatLng());mapLE.getZoom()<13&&mapLE.setView(e.layer.getLatLng(),mapLE.getZoom()+(13-lifeEventsMapData.ZoomLevel))}).on("ready",function(){mapLE.fitBounds(mapLE.featureLayer.getBounds())});PersonStory.map.lifeMapObject=mapLE}isUseMapModal&&$("#mapLifeEventsModalTemp").hide()}}function showEventMapModal(mapId){var modalContents=$("#modalContents"),mapJSONNarrativeModal,eventItem;modalContents.length>0&&(mapJSONNarrativeModal=modalContents.find("#mapJSONNarrativeModal"+mapId),mapJSONNarrativeModal.length>0&&mapJSONNarrativeModal.remove());eventItem=PersonStory.timeline.events[mapId];eventMapsInitializeSetData(mapId,eventItem.EventMapMapData);$("#mapJSONNarrativeModal"+mapId).modal({showLoading:!0,useCustomPadding:!0,title:"",width:"100%",onClose:function(){$(".photoOverlayButton.active").removeClass("active").closest("figure").focus()}})}function eventMapsInitialize(){for(var isUseMapModal,eventItem,i=0;i<PersonStory.timeline.events.length;i++)isUseMapModal=typeof PersonStory.map.useMapModal!="undefined"&&PersonStory.map.useMapModal!==null&&PersonStory.map.useMapModal.length>0&&PersonStory.map.useMapModal==="true",eventItem=PersonStory.timeline.events[i],eventMapsInitializeSetData(i,eventItem.EventMapMapData),isUseMapModal&&$("#mapJSONNarrativeModalTemp"+i).hide()}function eventMapsInitializeSetData(mapId,eventMapMapData){var isUseMapModal=typeof PersonStory.map.useMapModal!="undefined"&&PersonStory.map.useMapModal!==null&&PersonStory.map.useMapModal.length>0&&PersonStory.map.useMapModal==="true",eventMap=eventMapMapData,mapContainer,heightVal,figureMap,divHtml,map,geoJson;if(eventMap&&eventMap.MapImageUrl&&eventMap.MapUrl&&(isUseMapModal||($(".mapFigure .photoOverlayButton").hide(),$("#photoOverlayButton"+mapId).hide(),$("#staticMapJSONNarrative"+mapId).hide()),mapContainer=isUseMapModal?"mapJSONNarrativeModal"+mapId:"mapJSONNarrative"+mapId,isUseMapModal&&$("#mapJSONNarrativeModalTemp"+mapId).length>0&&($("#mapJSONNarrativeModalTemp"+mapId).remove(),typeof PersonStory.map.eventsMapArray[mapId]!="undefined"&&PersonStory.map.eventsMapArray[mapId]!==null&&(PersonStory.map.eventsMapArray[mapId].remove(),PersonStory.map.eventsMapArray[mapId]=null)),isUseMapModal&&(heightVal=$(window).height()-40,$("#mapJSONNarrativeModalTemp"+mapId).length&&$("#mapJSONNarrativeModalTemp"+mapId).length!==0||$('<div id="mapJSONNarrativeModalTemp'+mapId+'"><div id="'+mapContainer+'" style="height:'+heightVal+'px;" /><\/div>').appendTo("body")),$("#"+mapContainer).html(""),$("#"+mapContainer).show(),figureMap=$("#figureMap"+mapId),figureMap.show(),isUseMapModal||(divHtml='<div class="mapJSON" id="'+mapContainer+'"><div id="map-ui'+mapId+'" class="map-ui"><ul><li><a id="mapLink'+mapId+'" class="leaflet-control-mapbox-geocoder-toggle mapbox-icon mapbox-icon-geocoder" href="#"><\/a><\/li><\/ul><\/div><\/div>',figureMap.html(divHtml),$("figure.loading").removeClass("loading")),isUseMapModal&&$("#photoOverlayButton"+mapId).attr("href","javascript:showEventMapModal('"+mapId+"');"),typeof L!="undefined"&&(typeof PersonStory.map.eventsMapArray[mapId]=="undefined"||PersonStory.map.eventsMapArray[mapId]===null))){map=L.mapbox.map(mapContainer,PersonStory.map.account+"."+PersonStory.map.handle,{zoomControl:isUseMapModal?!0:!1,tileLayer:{format:"jpg70",noWrap:isUseMapModal?!1:!0,minZoom:isUseMapModal?3:2,maxZoom:13}});map.setView([eventMap.CenterLatitude,eventMap.CenterLongitude],eventMap.ZoomLevel);isUseMapModal||(map.dragging.disable(),map.scrollWheelZoom.disable(),$("#mapLink"+mapId).attr("href","javascript:window.open('"+eventMap.MapUrl+"', 'toolbar=no, scrollbars=no, resizable=no, width=600, height=1024');void(0);"));geoJson={type:"FeatureCollection",features:[{type:"Feature",properties:{"marker-symbol":eventMap.PinIcon,"marker-color":eventMap.PinColor,"marker-size":"medium","marker-type":eventMap.PinTitle.substr(0,eventMap.PinTitle.indexOf("<"))},geometry:{type:"Point",coordinates:[eventMap.CenterLongitude,eventMap.CenterLatitude]}}]};map.featureLayer.on("layeradd",function(e){var marker=e.layer,popupContent='<div class="popUpContent"><b>'+eventMap.PinTitle+"<\/b><\/div>";marker.bindPopup(popupContent,{closeButton:!1})});map.featureLayer.setGeoJSON(geoJson);map.featureLayer.on("mouseover",function(e){e.layer.openPopup()}).on("mouseout",function(e){e.layer.closePopup()}).on("click",function(e){personAnalyticsTrackClick("mapPinClick"+e.layer.feature.properties["marker-type"]);map.panTo(e.layer.getLatLng())}).on("ready",function(){map.fitBounds(map.featureLayer.getBounds())});PersonStory.map.eventsMapArray[mapId]=map}}function lifeEventsMapInitializeStatic(){var isUseMapModal=typeof PersonStory.map.useMapModal!="undefined"&&PersonStory.map.useMapModal!==null&&PersonStory.map.useMapModal.length>0&&PersonStory.map.useMapModal==="true",lifeEventsMapData=PersonStory.map.lifeEvents.data[0],i,longDiffPlacesVal,latDiffPlacesVal,mapCenter;if(PersonStory.map.lifeEvents.data!==null&&(isUseMapModal&&($(".mapFigure .photoOverlayButton").show(),$("#mapOverlayButton").attr("onclick","showLifeEventsMapModal();")),$(".mapFigure .photoOverlayButton").show(),typeof L!="undefined")){L.mapbox.accessToken=PersonStory.map.accessToken;isUseMapModal||$("#mapLink").attr("href","javascript:window.open('"+lifeEventsMapData.MapUrl+"', 'toolbar=no, scrollbars=no, resizable=no, width=800, height=800');void(0);");var geoJson={type:"FeatureCollection",features:parseLongLatValsStatic(lifeEventsMapData.LongLatList)},bounds=geojsonExtent(geoJson),size=[750,200],vp=geoViewport.viewport(bounds,size),pins=[],differentPlacesCnt=0,latPrevVal=0,longPrevVal=0,alternateCentering="";for(i=0;i<geoJson.features.length;i++)longDiffPlacesVal=Math.abs(Math.abs(geoJson.features[i].geometry.coordinates[0])-Math.abs(longPrevVal)),longPrevVal=geoJson.features[i].geometry.coordinates[0],latDiffPlacesVal=Math.abs(Math.abs(geoJson.features[i].geometry.coordinates[1])-Math.abs(latPrevVal)),latPrevVal=geoJson.features[i].geometry.coordinates[1],(longDiffPlacesVal>1||latDiffPlacesVal>1)&&differentPlacesCnt++,pins.push("pin-m-"+geoJson.features[i].properties.markerSymbol+"+"+geoJson.features[i].properties.markerColor+"("+geoJson.features[i].geometry.coordinates.join(",")+")"),alternateCentering.length===0&&(alternateCentering=geoJson.features[i].geometry.coordinates.join(","));var latLongDiffArr=getLatLongDifferenceValues(lifeEventsMapData.LongLatList),latDiffVal=latLongDiffArr[0],longDiffVal=latLongDiffArr[1],zoomLevel=differentPlacesCnt===1&&lifeEventsMapData.ZoomLevel>=7?latDiffVal>2&&latDiffVal<4&&longDiffVal>120&&lifeEventsMapData.ZoomLevel===8?lifeMapsZoomLevelEnhance(latDiffVal,longDiffVal,lifeEventsMapData.ZoomLevel):lifeEventsMapData.ZoomLevel:lifeMapsZoomLevelEnhance(latDiffVal,longDiffVal,lifeEventsMapData.ZoomLevel);((latDiffVal<2||longDiffVal<2)&&zoomLevel>6&&differentPlacesCnt===1||zoomLevel>6&&differentPlacesCnt>1)&&(zoomLevel=6);mapCenter=vp.center.join(",");(lifeEventsMapData.ZoomLevel<=2&&zoomLevel<=2||latDiffVal<13&&longDiffVal>50&&lifeEventsMapData.ZoomLevel<=3&&zoomLevel<=2||latDiffVal>9&&latDiffVal<20&&longDiffVal>4&&longDiffVal<32&&lifeEventsMapData.ZoomLevel<=3&&zoomLevel<=2||latDiffVal>6&&latDiffVal<25&&longDiffVal>4&&longDiffVal<35&&lifeEventsMapData.ZoomLevel>=8&&zoomLevel<=5||latDiffVal>8&&latDiffVal<10&&longDiffVal>2&&longDiffVal<3&&lifeEventsMapData.ZoomLevel===5&&zoomLevel===5||latDiffVal>10&&latDiffVal<42&&longDiffVal>110&&lifeEventsMapData.ZoomLevel===9&&zoomLevel===9&&differentPlacesCnt===1||latDiffVal<5&&longDiffVal<5&&lifeEventsMapData.ZoomLevel===7&&zoomLevel===7&&differentPlacesCnt===1||latDiffVal>35&&latDiffVal<40&&longDiffVal>60&&longDiffVal<65&&lifeEventsMapData.ZoomLevel===3&&zoomLevel===3||latDiffVal<30&&longDiffVal>130&&lifeEventsMapData.ZoomLevel<=3&&zoomLevel<=3||latDiffVal<6&&longDiffVal<16&&lifeEventsMapData.ZoomLevel<=2&&zoomLevel<=3||latDiffVal<13&&longDiffVal>100&&lifeEventsMapData.ZoomLevel===5||latDiffVal<40&&longDiffVal>130&&lifeEventsMapData.ZoomLevel===5)&&(mapCenter=alternateCentering);$("#static-map").attr("src","https://api.tiles.mapbox.com/v3/"+PersonStory.map.account+"."+PersonStory.map.handleBase+","+PersonStory.map.account+"."+PersonStory.map.handleLabels+"/"+pins.join(",")+"/"+mapCenter+","+(geoJson.features.length>1&&differentPlacesCnt>1?vp.zoom==="0"||vp.zoom==="1"?2:zoomLevel.toString():zoomLevel.toString())+"/"+size.join("x")+".jpg70").closest("figure.loading").removeClass("loading")}}function eventMapsInitializeStatic(){for(var eventItem,eventMap,figureMap,hrefVal,divHtml,isUseMapModal=typeof PersonStory.map.useMapModal!="undefined"&&PersonStory.map.useMapModal!==null&&PersonStory.map.useMapModal.length>0&&PersonStory.map.useMapModal==="true",i=0;i<PersonStory.timeline.events.length;i++)if(eventItem=PersonStory.timeline.events[i],eventMap=eventItem.EventMapMapData,eventMap&&eventMap.MapImageUrl&&eventMap.MapUrl&&(figureMap=$("#figureMap"+i),figureMap.show(),hrefVal="javascript:$('.mapFigure .photoOverlayButton').hide();$('#photoOverlayButton"+i+"').hide();eventMapsInitialize();lifeEventsMapInitialize();",isUseMapModal&&($("#photoOverlayButton"+i).show(),hrefVal="javascript:showEventMapModal('"+i+"');"),divHtml='<a class="ancBtn silver photoOverlayButton" id="photoOverlayButton'+i+'" style="display:inline-block;" href="'+hrefVal+'">'+PersonStory.text.interactWithMap+'<\/a><img alt="Map" class="staticMap" id="staticMapJSONNarrative'+i+'" />',figureMap.html(divHtml),$("figure.loading").removeClass("loading"),typeof L!="undefined")){var geoJson={type:"FeatureCollection",features:[{type:"Feature",properties:{markerSymbol:eventMap.PinIcon,markerColor:eventMap.PinColor,markerSize:"medium",markerType:eventMap.PinTitle.substr(0,eventMap.PinTitle.indexOf("<"))},geometry:{type:"Point",coordinates:[eventMap.CenterLongitude,eventMap.CenterLatitude]}}]},bounds=geojsonExtent(geoJson),size=[710,228],vp=geoViewport.viewport(bounds,size),pins="pin-m-"+geoJson.features[0].properties.markerSymbol+"+"+geoJson.features[0].properties.markerColor+"("+geoJson.features[0].geometry.coordinates.join(",")+")";$("#staticMapJSONNarrative"+i).attr("src","https://api.tiles.mapbox.com/v3/"+PersonStory.map.account+"."+PersonStory.map.handleBase+","+PersonStory.map.account+"."+PersonStory.map.handleLabels+"/"+pins+"/"+vp.center.join(",")+",7/"+size.join("x")+".jpg70")}}function individualEventMapsInitializeStatic(mapId,eventMapMapData){var isUseMapModal=typeof PersonStory.map.useMapModal!="undefined"&&PersonStory.map.useMapModal!==null&&PersonStory.map.useMapModal.length>0&&PersonStory.map.useMapModal==="true",eventMap=eventMapMapData,figureMap,hrefVal,divHtml;if(eventMap&&eventMap.MapImageUrl&&eventMap.MapUrl&&(PersonStory.timeline.events[mapId].EventMapMapData=eventMapMapData,figureMap=$("#figureMap"+mapId),figureMap.show(),hrefVal="javascript:$('.mapFigure .photoOverlayButton').hide();$('#photoOverlayButton"+mapId+"').hide();eventMapsInitialize();lifeEventsMapInitialize();",isUseMapModal&&(isUseMapModal&&($("#mapJSONNarrativeModalTemp"+mapId).length&&$("#mapJSONNarrativeModalTemp"+mapId).length!==0||$('<div id="mapJSONNarrativeModalTemp'+mapId+'"><div id="mapJSONNarrativeModal'+mapId+'" style="height:0px;"><\/div>').appendTo("body")),$("#mapJSONNarrativeModal"+mapId).html(""),$("#photoOverlayButton"+mapId).show(),hrefVal="javascript:showEventMapModal('"+mapId+"');"),divHtml='<a class="ancBtn silver photoOverlayButton" id="photoOverlayButton'+mapId+'" style="display:inline-block;" href="'+hrefVal+'">'+PersonStory.text.interactWithMap+'<\/a><img  alt="Map" class="staticMap" id="staticMapJSONNarrative'+mapId+'" />',figureMap.html(divHtml),$("figure.loading").removeClass("loading"),typeof L!="undefined")){var geoJson={type:"FeatureCollection",features:[{type:"Feature",properties:{markerSymbol:eventMap.PinIcon,markerColor:eventMap.PinColor,markerSize:"medium",markerType:eventMap.PinTitle.substr(0,eventMap.PinTitle.indexOf("<"))},geometry:{type:"Point",coordinates:[eventMap.CenterLongitude,eventMap.CenterLatitude]}}]},bounds=geojsonExtent(geoJson),size=[710,228],vp=geoViewport.viewport(bounds,size),pins="pin-m-"+geoJson.features[0].properties.markerSymbol+"+"+geoJson.features[0].properties.markerColor+"("+geoJson.features[0].geometry.coordinates.join(",")+")";$("#staticMapJSONNarrative"+mapId).attr("src","https://api.tiles.mapbox.com/v3/"+PersonStory.map.account+"."+PersonStory.map.handleBase+","+PersonStory.map.account+"."+PersonStory.map.handleLabels+"/"+pins+"/"+vp.center.join(",")+",7/"+size.join("x")+".jpg70")}}function parseLongLatVals(arr){for(var obj,result=[],i=0;i<arr.length;i++)obj={type:"Feature",properties:{details:arr[i].PinTitle,"marker-symbol":arr[i].PinIcon,"marker-color":arr[i].PinColor,"marker-size":"medium","marker-type":arr[i].PinTitle.substr(0,arr[i].PinTitle.indexOf("<"))},geometry:{type:"Point",coordinates:[arr[i].Longitude,arr[i].Latitude]}},result.push(obj);return result}function parseLongLatValsStatic(arr){for(var obj,result=[],i=0;i<arr.length;i++)obj={type:"Feature",properties:{details:arr[i].PinTitle,markerSymbol:arr[i].PinIcon,markerColor:arr[i].PinColor,markerSize:"medium",markerType:arr[i].PinTitle.substr(0,arr[i].PinTitle.indexOf("<"))},geometry:{type:"Point",coordinates:[arr[i].Longitude,arr[i].Latitude]}},result.push(obj);return result}function ancContentRemove(){}$(function(){initializeLifeStoryMenuOptionsCallout();loadScripts(PersonStory.jsAssets,function(){window.setTimeout(initializeMapbox,500)});$(".mapFigure, .mediaFigureMap").on("click",".photoOverlayButton",function(){$(this).addClass("active")})})