function Glue(defaultOptions){"use strict";function fetch(options,callback){$.when($.ajax({url:options.url,cache:!1})).then(function(responseData){processResponseSuccess(responseData,options);typeof callback!="undefined"&&callback!==null&&callback()})}function jsonpFetch(options,callback){$.when($.ajax({url:options.url+(options.url.indexOf("?")>=0?"&":"?")+"callback=?",cache:!1,dataType:"jsonp"})).then(function(responseData){processResponseSuccess(responseData,options);typeof callback!="undefined"&&callback!==null&&callback()})}function processResponseSuccess(responseData,options){try{options.pushUrlState===!0?History.pushState({tab:options.queryValue,rand:Math.random(),glueData:responseData,domId:options.domId,options:options},"tab "+options.queryValue,options.queryValue):glueContent(options,responseData);typeof options.callback!="undefined"&&options.callback!==null&&options.callback()}catch(ex){window.console!=null&&console.error("Glue Component Error: "+ex.message)}}function glueContent(options,responseData){var glueStatic=options.removeCacheFiles?"glueStatic":"",cdnCssPath="",cdnCssFiles=filteredCacheFiles(responseData.css.cdn),k,cdnJsPath,cdnJsFiles,keyIndex,j,event;for(keyIndex in cdnCssFiles)defaultOptions.combinatorPath?cdnCssPath+=(cdnCssPath.length?"&":"")+cdnCssFiles[keyIndex]:$("head").append('<link class="'+glueStatic+'" rel="stylesheet" href="'+cdnCssFiles[keyIndex]+'">');for(defaultOptions.combinatorPath&&cdnCssPath&&$("head").append('<link class="'+glueStatic+'" rel="stylesheet" href="'+defaultOptions.combinatorPath+"?"+cdnCssPath+'">'),$('link[class="glueStatic"]').remove(),k=0;k<responseData.css.local.length;k++)$('link[href="'+responseData.css.local[k]+'"]').length||$("head").append('<link class="'+glueStatic+'" rel="stylesheet" href="'+responseData.css.local[k]+'">');if($("#"+options.domId).html(responseData.html.body),responseData.js.asset)for(j=0;j<responseData.js.asset.length;j++)$.cachedScript(responseData.js.asset[j]);cdnJsPath="";cdnJsFiles=filteredCacheFiles(responseData.js.cdn,"javascript");for(keyIndex in cdnJsFiles)defaultOptions.combinatorPath?cdnJsPath+=(cdnJsPath.length?"&":"")+cdnJsFiles[keyIndex]:$.cachedScript(defaultOptions.combinatorPath);for(defaultOptions.combinatorPath&&cdnJsPath&&$.cachedScript(defaultOptions.combinatorPath+"?"+cdnJsPath),$('script[class="glueStatic"]').remove(),j=0;j<responseData.js.local.length;j++)$.cachedScript(responseData.js.local[j]);if(options.fadeIn&&$("#"+options.domId).fadeIn(),window.acom!=null&&window.acom.bus!=null)for(event in options.events)window.acom.bus.removeAllListeners(event),window.acom.bus.addListener(event,options.events[event])}function filteredCacheFiles(files,cacheType){if(typeof files=="undefined"||files.length===0)return[];var fileList="",currentLoadedFiles;return currentLoadedFiles=cacheType=="javascript"?$("script[src]"):$("link[href]"),currentLoadedFiles.each(function(i,val){fileList+=(cacheType=="javascript"?val.src:val.href)+" "}),$.map(files,function(val,i){var file=files[i],isNotLoaded=fileList.indexOf(file)==-1;if((defaultOptions.combinatorPath||file[0]!="x")&&isNotLoaded)return file;isNotLoaded&&window.console!=null&&console.error("Glue Component Error: The file "+file+" was not loaded.")})}function staticFetch(glueData){if(glueData===undefined||glueData===null){var options={key:defaultOptions.key,url:defaultOptions.url,domId:defaultOptions.domId,pushUrlState:!1,queryKey:"tab-"+defaultOptions.key,queryValue:defaultOptions.value};fetch(options)}else glueContent(defaultOptions,glueData)}function init(){History.Adapter.bind(window,"statechange",function(){var state=History.getState(),param=defaultOptions.key;(state.title!==""||state.title!=="")&&(param=state.data.tab.toLowerCase());typeof preProcess=="function"&&preProcess(param);state.data.glueData&&staticFetch(state.data.glueData)})}function reload(callback){var state=History.getState(),options=state.data.options?state.data.options:defaultOptions.options;options!=null&&fetch(options,callback)}var preProcess=null;Object.defineProperty(this,"preProcess",{get:function(){return preProcess},set:function(value){preProcess=value}});Object.defineProperty(this,"fetch",{get:function(){return fetch}});Object.defineProperty(this,"jsonpFetch",{get:function(){return jsonpFetch}});Object.defineProperty(this,"staticFetch",{get:function(){return staticFetch}});Object.defineProperty(this,"reload",{get:function(){return reload}});jQuery.cachedScript=function(url,options){return options=$.extend(options||{},{dataType:"script",cache:!0,url:url,crossDomain:!0}),jQuery.ajax(options)};init()}