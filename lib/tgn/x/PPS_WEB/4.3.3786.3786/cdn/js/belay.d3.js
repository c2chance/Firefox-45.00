var Belay=function($,d3){function off(){d3.selectAll("svg.ropebag").remove()}Array.max=function(array){return Math.max.apply(Math,array)};Array.min=function(array){return Math.min.apply(Math,array)};var defaults={animate:!1,strokeColor:"#777573",strokeWidth:2,opacity:1,fill:"none",distinct:!1,direction:"horizontal",offsetTop:null,offsetLeft:null};return $.fn.belay=function(targets,options){function getD3Elements(el){return el instanceof jQuery?d3.selectAll(el.get()):el instanceof Array?d3.selectAll(el):el instanceof HTMLElement?d3.select(el):(console.error("Trying to connect a belay to a "+el.constructor.name),!1)}var fromTop,topElement,fromLeft,leftElement,transLeft,transTop;if(targets.length==0||$(".tabActive .ropebag").length==0){off();return}var settings=defaults,target,source=d3.select(this.get(0)),line,lines=[],ropebag={},sourcePoint={};options instanceof Object&&$.extend(settings,options);var sourcePosition=source.node().getBoundingClientRect(),targetPosition={},targetDims={h:[],w:[],t:[],l:[]};target=getD3Elements(targets).each(function(){var rect=this.getBoundingClientRect();targetDims.t.push(rect.top);targetDims.l.push(rect.left);targetDims.h.push(rect.height);targetDims.w.push(rect.width)});settings.distinct&&off();ropebag.div=d3.select(".tabActive .ropebag");ropebag.rect=ropebag.div.node().getBoundingClientRect();ropebag.offset={};targetPosition.top=Array.min(targetDims.t);targetPosition.left=Array.min(targetDims.l);targetPosition.height=Array.min(targetDims.h);targetPosition.width=Array.min(targetDims.w);settings.direction==="vertical"?(fromTop=targetPosition.top-sourcePosition.top>0,topElement=fromTop?sourcePosition:targetPosition,ropebag.offset.top=Math.abs(topElement.top-ropebag.rect.top)+topElement.height,ropebag.height=Math.abs(sourcePosition.top-targetPosition.top)-topElement.height,sourcePoint.x=sourcePosition.left-ropebag.rect.left,sourcePoint.x+=$(this).closest("#childrenList").length>0||$(this).closest("#NoKnownChildren").length>0?topElement.width+5:topElement.width/2,sourcePoint.y=fromTop?0:ropebag.height,line=d3.svg.diagonal().projection(function(d){return[d.x,d.y]})):(fromLeft=targetPosition.left-sourcePosition.left>0,leftElement=fromLeft?sourcePosition:targetPosition,ropebag.offset.left=Math.abs(leftElement.left-ropebag.rect.left)+leftElement.width,ropebag.width=Math.abs(sourcePosition.left-targetPosition.left)-leftElement.width,sourcePoint.x=fromLeft?0:ropebag.width,sourcePoint.y=sourcePosition.top-ropebag.rect.top+(settings.offsetTop||sourcePosition.height/2),line=d3.svg.diagonal().source(function(d){return{x:d.source.y,y:d.source.x}}).target(function(d){return{x:d.target.y,y:d.target.x}}).projection(function(d){return[d.y,d.x]}));transLeft=""+(ropebag.offset.left||0);transTop=""+(ropebag.offset.top||0);ropebag.svg=ropebag.div.append("svg").attr("class","ropebag").attr("height",ropebag.height||ropebag.rect.height).attr("width",ropebag.width||ropebag.rect.width).attr("style","left:"+transLeft+"px; top:"+transTop+"px;").attr("focusable","false").append("g");target.each(function(){var targetPoint={},position=this.getBoundingClientRect(),fromTop,topElement,fromLeft,leftElement;settings.direction==="vertical"?(fromTop=position.top-sourcePosition.top>0,topElement=fromTop?sourcePosition:position,targetPoint.x=position.left-ropebag.rect.left+(settings.offsetLeft||position.width/2),targetPoint.y=fromTop?ropebag.height:Math.abs(position.height-targetPosition.height)):(fromLeft=position.left-sourcePosition.left>0,leftElement=fromLeft?sourcePosition:position,targetPoint.x=fromLeft?ropebag.width:Math.abs(position.width-targetPosition.width),targetPoint.y=position.top-ropebag.rect.top+(settings.offsetTop||position.height/2));lines.push({source:sourcePoint,target:targetPoint})});ropebag.svg.selectAll(".belayline").data(lines).enter().append("path").attr("stroke",settings.strokeColor).attr("stroke-width",settings.strokeWidth).attr("fill",settings.fill).attr("class","belayline").attr("d",line);d3.selectAll(".belayline").each(function(d){d.totalLength=this.getTotalLength();d3.select(this).attr("stroke-dasharray",d.totalLength+" "+d.totalLength).attr("stroke-dashoffset",d.totalLength)});settings.animate?d3.selectAll(".belayline").transition().duration(250).ease("linear").attr("stroke-dashoffset",0).each("end",function(){typeof settings.callback=="function"&&settings.callback()}):d3.selectAll(".belayline").attr("stroke-dashoffset",0).call(function(){typeof settings.callback=="function"&&settings.callback()})},{off:off}}(jQuery,d3)