(function($,window){function requestHandler(waitTime){function finishWaitWork(){clearTimeout(timeoutId);timeoutId=-1;waiting&&hideWait()}var waiting=!1,timeoutId=-1,showWait=function(){$("#editRelationshipsModal").addClass("modalPersonViewNoPointerEvents").fadeTo("fast",.3)},hideWait=function(){$("#editRelationshipsModal").fadeTo("fast",100,function(){$("#editRelationshipsModal").removeClass("modalPersonViewNoPointerEvents")})};this.handleRequest=function(makeRequest){if(timeoutId!==-1){showWait();return}timeoutId=setTimeout(function(){timeoutId&&(waiting=!0,showWait())},waitTime);makeRequest(finishWaitWork)}}if(!window.editRelationship){var getLocalizedString=function(str,params){var localizedStr=str;for(var prop in params)localizedStr&&(localizedStr=localizedStr.replace(new RegExp("{"+prop+"}","g"),params[prop]));return localizedStr},removeEventHandlers=function($parentEl){$parentEl.find("button, a").off("click");$parentEl.find("select").off("change")};window.editRelationship=function(options){var settings=$.extend({waitTime:500},options),Relationship,$focusCtrl,setupRemoveRelationshipButtons,isZeroState;window.editRelationship.updated=window.editRelationship.updatedSaved;Relationship={father:"0",mother:"1",husband:"2",wife:"3",child:"4",isParent:function(type){return type===Relationship.father||type===Relationship.mother},isSpouse:function(type){return type===Relationship.husband||type===Relationship.wife}};$.fn.slideFadeToggle=function(speed,easing,callback){return $("#editRelationshipsModal").addClass("modalPersonViewNoPointerEvents"),this.animate({opacity:"toggle",height:"toggle"},speed,easing,function(){$("#editRelationshipsModal").removeClass("modalPersonViewNoPointerEvents");typeof callback=="function"&&callback()})};var animationConstructor=function(){return{items:".card:not(.cardEmpty)",animateMove:{afterAnimate:function(item,list){item.removeClass("alternate");var $prefCard=$(".alternateCard");$prefCard.addClass("alternate");$prefCard.removeClass("alternateCard");$("#editRelationshipsModal").removeClass("modalPersonViewNoPointerEvents");list.children(".cardEmpty.addRelationships").insertAfter(item)},beforeAnimate:function(item,list){var $addRelCard=list.find(".addRelationships");$addRelCard.is(":visible")&&$addRelCard.fadeOut("500");$("#editRelationshipsModal").addClass("modalPersonViewNoPointerEvents")},closeOnAnimate:".cardEmpty.addRelationships"},animateRemove:{afterRemove:function(){updatePersonTypeahead()},beforeRemove:function(item,data){var cardData=data.cardData,$section=item.closest("section"),$addRelCard=$section.find(".addRelationships"),$newPrimaryParent,response1;Relationship.isParent(cardData.type)&&cardData.priority===1&&($newPrimaryParent=$section.find(".parentCard:eq(1)"),$newPrimaryParent.length&&(response1={success:!0,priority:"1"},updateState($newPrimaryParent,response1,"priority"),$newPrimaryParent.removeClass("alternate"),$addRelCard.insertAfter($newPrimaryParent)))},duration:300,emptyContent:".zeroState"},animateAdd:{afterAdd:function(){updatePersonTypeahead();setupRemoveRelationshipButtons($(".modalEditRelationship .relationshipOptions .iconClose"))},beforeAdd:function(item,list){var $section=item.closest("section"),$addRelCard=list.find(".addRelationships"),$zeroCard=$section.closest(".zeroState");$zeroCard.remove();$addRelCard.is(":visible")&&list.children(".card:not(.cardEmpty)").length&&$addRelCard.find(".erAddCancel").click()},emptyContent:".addRelationships"}}},getCardData=function($card){return $card.data("data")},getParentSpouseCardData=function($card){var $spouseGroup=$card.closest("div.spouseGroup"),$spouseCard=$spouseGroup.find("section.spouse div.card").not(".cardEmpty");return $spouseCard.length===0&&($spouseCard=$spouseGroup.find("section.spouse div.card.zeroState")),getCardData($spouseCard)},getRelationChar=function(relationType){var relationshipChar="";switch(relationType){case Relationship.father:relationshipChar="f";break;case Relationship.mother:relationshipChar="m";break;case Relationship.husband:relationshipChar="h";break;case Relationship.wife:relationshipChar="w";break;case Relationship.child:relationshipChar="c"}return relationshipChar},getCard=function($descendentEl,selector){return $descendentEl.target&&($descendentEl=$($descendentEl.target)),$descendentEl.closest(selector)},getRelationCount=function($el){return $el.closest("section").find(".card:not(.cardEmpty)").length},getAddRelButton=function(el){var $el=el instanceof jQuery?el:$(el);return $el.closest("section").find(".openAddRel")},deleteCard=function($card,cardData,response){var $section=$card.closest("section"),$addRelCard=$section.find(".addRelationships"),$newCard,isZeroState,$spouseGroups,$uSpouseGroup;if(response.card){if($newCard=$(response.card),isZeroState=$section.find(".zeroState").length>0,Relationship.isSpouse(cardData.type)){$section.closest(".spouses").html($newCard.hide());$newCard.fadeIn("slow",function(){$("section.spouses .relationList:not(.animatedList)").animateCard(animationConstructor());updatePersonTypeahead();setupRemoveRelationshipButtons($(".modalEditRelationship .relationshipOptions .iconClose"))});return}if(cardData.type===Relationship.child&&($spouseGroups=$("section .spouseGroup"),$uSpouseGroup=$card.closest("section .spouseGroup"),$spouseGroups.length>1&&$uSpouseGroup.hasClass("unknownSpouseGroup"))){deleteSpouseGroup($uSpouseGroup);updatePersonTypeahead();return}getAddRelButton($card).removeClass("openAddRelActive");$newCard.insertBefore($addRelCard).hide()}$card.trigger("animateListItem.remove",[{cardData:cardData}])},showNewCard=function($newCard,fromZeroState){fromZeroState?$newCard.fadeIn("slow"):$newCard.show()},addCard=function($addRelCard,cardData,response){var $section=$addRelCard.closest("section"),$previousCard;if(response.card){var $newCard=$(response.card),$zeroCard=$section.find(".zeroState"),inZeroState=!1;$zeroCard.length&&(inZeroState=!0,$zeroCard.fadeOut("normal",function(){$zeroCard.remove()}),getAddRelButton($addRelCard).addClass("openAddRelActive"));Relationship.isParent(cardData.type)&&getRelationCount($addRelCard)>0?$section.trigger("animateListItem.add",[$newCard,{position:"last",delay:500}]):Relationship.isParent(cardData.type)?$section.trigger("animateListItem.add",[$newCard,{previous:$addRelCard,delay:500,empty:inZeroState}]):Relationship.isSpouse(cardData.type)?($zeroCard.remove(),$section.closest(".spouses").html($newCard.hide()),$newCard.fadeIn("slow",function(){$("section.spouses .relationList:not(.animatedList)").animateCard(animationConstructor());updatePersonTypeahead();setupRemoveRelationshipButtons($(".modalEditRelationship .relationshipOptions .iconClose"))})):($previousCard=getPreviousLifeRangeCard($newCard,$section,response.index),$previousCard==null?$section.trigger("animateListItem.add",[$newCard,{position:"last"}]):$section.trigger("animateListItem.add",[$newCard,{previous:$previousCard}]))}},getPreviousLifeRangeCard=function($newCard,$section,index){var $previousCard=null,$children=$section.find(".card:not(.cardEmpty)");return $children.length>0&&$children.length>index&&($previousCard=$children.eq(index)),$previousCard},statusHandler=function($this,response,callback){if(response.success){var className="relationshipOptionSuccess",$checkmark=$this.closest(".card").find(".relationshipOption .success"),$checkContainer=$checkmark.parent(".relationshipOption");$checkContainer.addClass(className);$checkmark.fadeIn(100).delay(1500).fadeOut(1e3,function(){$checkContainer.removeClass(className);callback()})}else callback()};settings.addedPid&&setTimeout(function(){var card=$("."+settings.addedPid);$("#modal").animate({scrollTop:card.offset().top-20},200);statusHandler(card,{success:!0},$.noop)},400);var updateState=function($card,response,attribute){var data=$card.data("data");return response.success&&(data[attribute]=response[attribute],$card.data("data",data)),!1},errorState=function($card,errorText){var alertDiv="<div><p>"+decodeURIComponent(errorText)+"<\/p><\/div>";$(alertDiv).appendTo($card).alert({display:"overlay",duration:5e3,type:"warning"})},deleteSpouseGroup=function($spouseGroup){removeEventHandlers($spouseGroup);$spouseGroup.fadeOut("normal",function(){$spouseGroup.remove();updatePersonTypeahead();$.modal.center()});return},updateSelects=function(cardData,response,val){var selRid="div ."+cardData.rid;$(selRid).each(function(){var $item=$(this);$item.find("select").val(val);updateState($item,response,"modifier")})},_requestHandler=new requestHandler(settings.waitTime);$(".modalEditRelationship").on("change.editRelationship","select",function(event){window.personAnalyticsTrackClick("EditRelationshipModalChangeRelationship");var $this=$(this),val=$this.val();_requestHandler.handleRequest(function(onFinishCallback){var $card=getCard(event,".card"),cardData=getCardData($card),params={type:cardData.type,originalModifier:cardData.modifier,modifier:event.target.value},url=settings.strings.editRelationshipUrl+"/update";url=url.replace("{rid}",cardData.rid);$card.addClass("loading");$.ajax({type:"POST",url:url,data:params,cache:!1,success:function(response){$card.removeClass("loading");statusHandler($this,response,function(){response.success?updateSelects(cardData,response,val):($this.val(cardData.modifier),errorState($card,settings.strings.erModifierError))})},failure:function(response){$card.removeClass("loading");statusHandler($this,response,function(){$this.val(cardData.modifier);errorState($card,settings.strings.erModifierError)})},complete:function(){typeof onFinishCallback!="undefined"&&onFinishCallback()}})})}).on("click.relationship.update.priority",".card button.makePreferred",function(event){window.personAnalyticsTrackClick("EditRelationshipModalChangePreferred");var $this=$(this);_requestHandler.handleRequest(function(onFinishCallback){var $card=getCard(event,".card"),cardData=getCardData($card),params={type:cardData.type,modifier:cardData.modifier,priority:1},name=cardData.fullName.replace(/\+/g," "),errMsgParams={name:name},$cards=$card.closest("section").find(".card"),$preferredCard=$cards.filter(":first"),url=settings.strings.editRelationshipUrl+"/update",errorMessage;url=url.replace("{rid}",cardData.rid);errorMessage=getLocalizedString(options.strings.erPriorityError,errMsgParams);$card.addClass("loading");$.ajax({type:"POST",url:url,data:params,cache:!1,success:function(response){if($card.removeClass("loading"),response.success){$preferredCard.addClass("alternateCard");updateState($card,response,"priority");updateState($preferredCard,{success:!0,priority:"0"},"priority");$card.trigger("animateListItem.move");window.editRelationship.updated=!0}else errorState($card,errorMessage)},failure:function(response){$card.removeClass("loading");statusHandler($this,response,function(){errorState($card,errorMessage)})},complete:function(){typeof onFinishCallback!="undefined"&&onFinishCallback()}})})}).on("click.relationship.add",".addRelationship",function(event){_requestHandler.handleRequest(function(onFinishCallback){var $addRelCard=$(event.target).closest(".card"),data=$addRelCard.find(".erAddExistingData").data("itemData"),pid=data.PID,name=data.name,cardData=getCardData($addRelCard),relCount=getRelationCount($addRelCard),zeroState=isZeroState($addRelCard),trackString=zeroState?"EditRelationshipAddExisting:zeroState":"EditRelationshipAddExisting",params,spouseData,spid,url,msgParams,errorMessage;window.personAnalyticsTrackClick(trackString);params={type:cardData.type,originalModifier:cardData.modifier,modifier:event.target.value,existpid:pid,relation:getRelationChar(cardData.type),isSibling:!1,isAltParent:Relationship.isParent(cardData.type)&&getRelationCount($addRelCard)>0?!0:!1,priority:relCount>0?"0":"1",zeroState:zeroState};cardData.type===Relationship.child&&(spouseData=getParentSpouseCardData($addRelCard),spid=typeof spouseData.rid!="undefined"?spouseData.rid:0,params.parentSet=spid!==0?spid+":"+settings.focus.pid:":"+settings.focus.pid);url=settings.strings.editRelationshipUrl+"/add";url=url.replace("{rid}",pid);$addRelCard.addClass("loading");name=name.replace(/\+/g," ");msgParams={name:name};errorMessage=getLocalizedString(options.strings.erAddError,msgParams);$.ajax({type:"POST",url:url,data:params,cache:!1,success:function(response){$addRelCard.removeClass("loading");response.success?addCard($addRelCard,cardData,response):response.message!==""?errorState($addRelCard,response.message):errorState($addRelCard,errorMessage);window.editRelationship.updated=!0},failure:function(){errorState($addRelCard,errorMessage)},complete:function(){$addRelCard.removeClass("loading");typeof onFinishCallback!="undefined"&&onFinishCallback()}})})}).on("keypress",".zeroState",function(e){var $this=$(this);(e.keyCode===32||e.keyCode===13)&&$this.trigger("click")}).on("click.relationship.add",".openAddRel",function(event){var $section=getCard(event,"section"),$addRelCard=$section.find(".addRelationships"),$card=$(this),cardData=getCardData($addRelCard),zeroState;$focusCtrl=$card;zeroState=isZeroState($addRelCard);$addRelCard.is(":hidden")?(closeAllAdds(),zeroState?(window.personAnalyticsTrackClick("EditRelationshipAddClickedZeroState"),$card.fadeTo("normal",.3,function(){$card.hide();$addRelCard.fadeTo("normal",1,function(){$addRelCard.find(".erFindExistingPerson").focus()})})):(window.personAnalyticsTrackClick("EditRelationshipAddClicked"),$addRelCard.slideFadeToggle("500","swing",function(){$addRelCard.find(".erFindExistingPerson").focus()})),$.get(settings.strings.editRelationshipLoggingUrl+"addrelationshipstart?type="+cardData.type)):$addRelCard.find(".erAddCancel").trigger("click")}).on("click.relationship.add",".erAddCancel",function(event){var $addRelCard=getCard(event,".card"),$section=$addRelCard.closest("section"),$zeroStateCard=$section.find(".cardEmpty.zeroState"),$input;$zeroStateCard.length>0?$addRelCard.fadeTo("normal",.3,function(){$zeroStateCard.fadeTo("normal",1,function(){$zeroStateCard.focus()});$addRelCard.hide()}):$addRelCard.slideFadeToggle("500","swing",function(){$focusCtrl.focus()});$input=$addRelCard.find(".erFindExistingPerson");$input.val("");$input.removeAttr("data-extra");$addRelCard.find(".erAddExistingData").data("itemData","");$addRelCard.find(".erAddSave").prop("disabled",!0)}).on("click.person.add","a.addNewPerson",function(){}).on("click.relationship.add",".erAddNew",function(event){var $section=getCard(event,"section"),$addRelCard=$section.find(".addRelationships"),cardData=getCardData($addRelCard),relationship=getRelationChar(cardData.type),addPersonArgs={rel:""+relationship,showAddNewOnly:"true",IsTransition:"true"},isAltParent=Relationship.isParent(cardData.type)&&getRelationCount($addRelCard)>0?!0:!1,spouseData,spid,apmCallback;isAltParent&&(addPersonArgs.alt="1");cardData.type===Relationship.child&&(spouseData=getParentSpouseCardData($addRelCard),spid=typeof spouseData.rid!="undefined"?spouseData.rid:0,addPersonArgs.sid=""+spid);window.editRelationship.updatedSaved=window.editRelationship.updated;window.editRelationship.updated=!1;window.personAnalyticsTrackClick("EditRelationshipAddNewPersonClicked");$.get(settings.strings.editRelationshipLoggingUrl+"addrelationshipnew?type="+cardData.type);apmCallback=function(cbResponse){if(cbResponse.status==="success"){window.personAnalyticsTrackClick("EditRelationshipNewPersonSaved");$("#toggleSiblingsButton").unbind("click");var params=$genTreesModal.Params,paramJson;params&&params.length>0&&(paramJson=jQuery.parseJSON(params));paramJson!=null&&typeof paramJson.rel!="undefined"&&paramJson.rel==="s"&&(PersonCard.isAddSibling=!0,$("#toggleSiblingsButton").unbind("click"))}return editRelationships(cbResponse.newPid,relationship,!0),!0};AddPerson.Add(settings.focus.tid,settings.focus.pid,addPersonArgs,apmCallback)});$focusCtrl=$(".closeBtn");setupRemoveRelationshipButtons=function($removeRelButtons){$removeRelButtons.each(function(index,element){var $this=$(element),$card=getCard($this,".card"),cardData=$card.data("data"),relationship="";switch(cardData.type){case Relationship.father:relationship=options.relationTypes.father;break;case Relationship.mother:relationship=options.relationTypes.mother;break;case Relationship.husband:case Relationship.wife:relationship=options.relationTypes.spouse;break;case Relationship.child:relationship=options.relationTypes.child}var name=cardData.fullName.replace(/\+/g," "),msgParams={name:name,relationship:relationship,focusName:settings.focus.name},title=options.strings.removeConfirmationTitle,message=getLocalizedString(options.strings.removeConfirmationMessage,msgParams),errorMessage=getLocalizedString(options.strings.erRemoveError,msgParams),remove=options.strings.remove,cancel=options.strings.cancel;$this.callout({content:'<div class="constrainCallout"><h5>'+title+"<\/h5><p>"+decodeURIComponent(message)+'<\/p><footer class="ancGrid ancGridSmall topSpacing"><div class="ancCol w50"><button class="ermRemove ancBtn lrg full" type="button">'+remove+'<\/button><\/div><div class="ancCol w50"><button class="ermCancel ancBtn silver lrg full" type="button">'+cancel+"<\/button><\/div><\/footer><\/div>",style:"dark",onAfterOpen:function(){var $content=$("#calloutContent");$content.find(".ermCancel").click(function(){$this.callout("close")});$content.find(".ermRemove").click(function(){closeAllAdds();_requestHandler.handleRequest(function(onFinishCallback){var params={rid:cardData.rid,type:cardData.type,count:getRelationCount($card)},url=settings.strings.editRelationshipUrl+"/remove";url=url.replace("{rid}",cardData.rid);$card.addClass("loading");$.ajax({type:"POST",url:url,data:params,cache:!1,success:function(response){$card.removeClass("loading");response.success?(deleteCard($card,cardData,response),window.editRelationship.updated=!0):($this.val(cardData.modifier),errorState($card,errorMessage))},failure:function(response){$card.removeClass("loading");statusHandler($this,response,function(){updateState($card,response,"modifier")})},complete:function(){$card.removeClass("loading");typeof onFinishCallback!="undefined"&&onFinishCallback()}})});$removeRelButtons.callout("close")})}})})};setupRemoveRelationshipButtons($(".modalEditRelationship .relationshipOptions .iconClose"));$.cachedScript(settings.strings.animateCardUrl).done(function(){$("section.relationList").animateCard(animationConstructor())});$(".erFindExistingPerson").on("keyup",function(e){var keycode,$card;window.event?keycode=window.event.keyCode:e&&(keycode=e.which);keycode!==13&&($card=getCard($(this),".card"),$card.find(".erAddExistingData").data("itemData",""),$card.find(".erAddSave").prop("disabled",!0))});var getAllRids=function(){return $.map($("#editRelationshipsModal .card"),function(card){var data=getCardData($(card));return data&&data.rid!==0?data.rid:null})},updatePersonTypeahead=function(){var rids=getAllRids();rids.push(settings.focus.pid);rids=rids.concat(settings.focus.siblingIds);$("#editRelationshipsModal .erFindExistingPerson").each(function(){var $erFindExistingPerson=$(this),autoCompleteUrl=settings.strings.autoCompleteUrl.replace("{excludePids}",rids.join());$erFindExistingPerson.autocomplete({source:autoCompleteUrl,key:"name",queryParameter:"term",dataType:"json",minLength:3,maxResults:20,customDisplay:function(data){var displayText=data.display;return(data.raw.birth!=""||data.raw.death!="")&&(displayText+=" "+data.raw.birth+" - "+data.raw.death),{value:data.value,display:displayText}},onItemSelect:function(itemData){var $this,$card;itemData!==""&&($this=$(this),itemData.PID!=""&&($card=$this.closest(".card"),$card.find(".erAddExistingData").data("itemData",itemData),$card.find(".erAddSave").prop("disabled",!1)))},onOpen:!1,onClose:!1});$(".addRelationships .erFindExistingPerson").val("").removeAttr("data-extra");$(".addRelationships .erAddExistingData").prop("value","");$(".addRelationships .erAddSave").prop("disabled",!0)})},closeAllAdds=function(){var $cancelBtns=$("button.erAddCancel:visible");$cancelBtns.each(function(){$(this).click()})};updatePersonTypeahead();isZeroState=function($this){var retValue=!1,$section=$this.closest("section"),$zeroState;return $section.length>0&&($zeroState=$section.find("div.card.zeroState"),retValue=$zeroState.length>0),retValue}};window.editRelationship.updated=!1;window.editRelationship.updatedSaved=!1}})(jQuery,window)