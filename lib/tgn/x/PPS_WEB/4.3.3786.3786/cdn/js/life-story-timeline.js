"use strict";function storyItemInitTypeAhead(locationField){var treeId=$(".treeId").val();locationField.autocomplete({source:"/suggest/place?treeId="+treeId+"&tad=none",key:"placeName",queryParameter:"term",dataType:"json",minLength:3,maxResults:12,customDisplay:function(data){return{value:data.value,display:data.display}},onItemSelect:function(){},onOpen:!1,onClose:!1})}function ignoreHistoricalInsight(historicalInsightId){var ignoreUrl="/tree/"+PersonCard.treeId+"/person/"+PersonCard.personId+"/historicalinsightid/"+historicalInsightId+"/ignoreHistoricalInsight";$.ajax({url:ignoreUrl,method:"GET",success:function(data){if(data.result){var historicalInsight=$("."+historicalInsightId);$("html").data({"saved-event-id":historicalInsightId,"saved-scroll-top":historicalInsight.offset().top,"saved-event-rect-top":historicalInsight[0].getBoundingClientRect().top});window.glue.reload()}}})}function savePersonLifestoryNarrative(){var lifeStoryNarrative=$(".lifeStoryNarrative"),narrativeText=lifeStoryNarrative.find(".narrativeText"),lifeStoryNarrativeText=narrativeText.text(),narrativeOriginalTextTemp=narrativeText.attr("data-narrative-original"),url;if(lifeStoryNarrativeText===narrativeOriginalTextTemp){$(".closeNarEditingCancel").trigger("click");return}narrativeText.length>0&&narrativeText.attr("data-narrative-original",lifeStoryNarrativeText);url="/tree/"+PersonCard.treeId+"/person/"+PersonCard.personId+"/savepersonlifestorynarrative";$.ajax({type:"POST",url:url,cache:!1,timeout:2e4,data:{narrative:lifeStoryNarrativeText},success:function(data){if(data.result){if(data.eventNarrative!=null){var lifeStoryNarrativeData=narrativeText.attr("data-narrative-original");lifeStoryNarrativeText.length===0?window.location.reload():lifeStoryNarrativeText.length!==lifeStoryNarrativeData&&window.glue.reload()}}else acom!=null&&acom.bus!=null&&typeof PersonStory!="undefined"&&acom.bus.emit("LifeStory::Notify::Failure",PersonStory.narrative.updateError,"",!0)},error:function(){narrativeText.attr("data-narrative-original",narrativeOriginalTextTemp);acom!=null&&acom.bus!=null&&typeof PersonStory!="undefined"&&acom.bus.emit("LifeStory::Notify::Failure",PersonStory.narrative.updateError,"",!0)}})}function savePersonNarrativeAndEventData(assertionid){var storyItem=$("."+assertionid),eventChanged=!1,narrativeChanged=!1,eventType=storyItem.find(".eventType").val(),dateField=storyItem.find("#"+assertionid+"DateField").val(),placeField=storyItem.find("#"+assertionid+"LocationField").val(),placeFieldDataExtra=storyItem.find("#"+assertionid+"LocationField").attr("data-extra"),descriptionField=storyItem.find(".storyDesc").text(),relationshipId=storyItem.find(".relationshipId").val(),originalDateVal=storyItem.find("#"+assertionid+"DateField").attr("data-placeholder"),originalPlaceVal=storyItem.find("#"+assertionid+"LocationField").attr("data-placeholder"),originalDescriptionVal=storyItem.find(".storyDesc").attr("data-placeholder"),placeGpid="",saveValue,url;typeof placeFieldDataExtra!="undefined"&&placeFieldDataExtra.length>0&&$.each($.parseJSON(placeFieldDataExtra),function(key,value){key==="GPID"&&(placeGpid=value)});(typeof originalDateVal!="undefined"&&typeof dateField!="undefined"&&originalDateVal!==dateField||typeof originalPlaceVal!="undefined"&&typeof placeField!="undefined"&&originalPlaceVal!==placeField||typeof originalDescriptionVal!="undefined"&&typeof descriptionField!="undefined"&&originalDescriptionVal!==descriptionField)&&(eventChanged=!0);var narrativeTitleField=storyItem.find(".storyType").text(),originalNarrativeTitleVal=storyItem.find(".storyType").attr("data-placeholder"),narrativeField=storyItem.find(".storyNarr").text(),originalNarrativeVal=storyItem.find(".storyNarr").attr("data-placeholder"),timelineItemHidden=storyItem.hasClass("timelineItemHiding"),timelineItemMapVisible=storyItem.hasClass("timelineItemMapVisible")&&storyItem.hasClass("timelineItemHasMap"),timelineItemMapVisibleOriginal=storyItem.find(".narrIsMapOn").val(),timelineItemImageVisible=storyItem.hasClass("timelineItemImageVisible"),timelineItemImageVisibleOriginal=storyItem.find(".narrIsMediaOn").val();(timelineItemHidden||typeof originalNarrativeTitleVal!="undefined"&&typeof narrativeTitleField!="undefined"&&originalNarrativeTitleVal!==narrativeTitleField||typeof originalNarrativeVal!="undefined"&&typeof narrativeField!="undefined"&&originalNarrativeVal!==narrativeField||typeof timelineItemMapVisible!="undefined"&&typeof timelineItemMapVisibleOriginal!="undefined"&&timelineItemMapVisible.toString()!==timelineItemMapVisibleOriginal.toString().toLowerCase()||timelineItemImageVisible.toString()!==timelineItemImageVisibleOriginal.toString().toLowerCase())&&(narrativeChanged=!0);saveValue="";eventChanged&&narrativeChanged?saveValue="0":eventChanged?saveValue="1":narrativeChanged&&(saveValue="2");saveValue.length>0&&(eventChanged||narrativeChanged)?(PersonStory.map.useMapModal&&$('[id^="mapJSONNarrativeModal"]').length>0&&$('[id^="mapJSONNarrativeModal"]').remove(),url="/tree/"+PersonCard.treeId+"/person/"+PersonCard.personId+"/assertionid/"+assertionid+"/savepersonnarrativeandeventdata",$.ajax({type:"POST",url:url,cache:!1,timeout:2e4,data:{saveContentValue:saveValue,title:narrativeTitleField,narrative:narrativeField,isHidden:timelineItemHidden,isMapOn:timelineItemMapVisible,isImageOn:timelineItemImageVisible,preferredImageId:storyItem.find(".storyPreferredImageId").val(),eventId:storyItem.find(".eventId").val(),eventType:eventType,date:dateField,place:placeField,placeGpid:placeGpid,description:descriptionField,relationshipId:relationshipId},success:function(data){data.result?storyItem.data("refresh")=="1"?location.reload():($("html").data({"saved-event-id":assertionid,"saved-scroll-top":storyItem.offset().top,"saved-event-rect-top":storyItem[0].getBoundingClientRect().top}),window.glue.reload()):acom!=null&&acom.bus!=null&&typeof PersonStory!="undefined"&&acom.bus.emit("LifeStory::Notify::Failure",PersonStory.narrative.updateError,"",!0)},error:function(){acom!=null&&acom.bus!=null&&typeof PersonStory!="undefined"&&acom.bus.emit("LifeStory::Notify::Failure",PersonStory.narrative.updateError,"",!0)}}),cancelEdit=!1):cancelEdit=!0}function getTimlineEventMapData(assertionid,hasMap){var storyItem=$("."+assertionid),mediaFigureMap=storyItem.find(".mediaFigureMap"),url;hasMap||mediaFigureMap.length!==0||storyItem.find(".addMediaDivMap").after('<figure class="mediaFigure mediaFigureMap"><div id="figureMap'+assertionid+'"><div class="mapJSON" id="mapJSONNarrative'+assertionid+'"><div id="map-ui'+assertionid+'" class="map-ui"><a id="mapLink'+assertionid+'" class="leaflet-control-mapbox-geocoder-toggle mapbox-icon mapbox-icon-geocoder" href="#"><\/a><\/div><\/div><\/div><\/figure>');url="/tree/"+PersonCard.treeId+"/person/"+PersonCard.personId+"/assertionid/"+assertionid+"/getpersonlifestoryeventmapdata";$.ajax({type:"GET",url:url,cache:!1,timeout:2e4,success:function(data){if(data.result&&data.EventMapMapData!=null)if(hasMap)if(mediaFigureMap.length>0){var figureMap=mediaFigureMap.children(":first").attr("id"),mapId=figureMap.substring(9,figureMap.length);individualEventMapsInitializeStatic(mapId,data.EventMapMapData);eventMapsInitializeSetData(mapId,data.EventMapMapData);$("#mapJSONNarrativeModalTemp"+mapId).hide()}else individualEventMapsInitializeStatic(assertionid,data.EventMapMapData),eventMapsInitializeSetData(assertionid,data.EventMapMapData),$("#mapJSONNarrativeModalTemp"+assertionid).hide();else storyItem.find(".storyCuration").find(".toggleMap").removeAttr("onclick"),individualEventMapsInitializeStatic(assertionid,data.EventMapMapData),eventMapsInitializeSetData(assertionid,data.EventMapMapData),$("#mapJSONNarrativeModalTemp"+assertionid).hide()}})}var cancelEdit=!1;$(function(){$("html").data("saved-event-id")&&($("."+$("html").data("saved-event-id")).length>0?($("html, body").scrollTop($("."+$("html").data("saved-event-id")).offset().top-$("html").data("saved-event-rect-top")),$("."+$("html").data("saved-event-id")).focus()):$("html, body").scrollTop($("html").data("saved-scroll-top")-$("html").data("saved-event-rect-top")),$("html").removeData("saved-event-id").removeData("saved-scroll-top").removeData("saved-event-rect-top"));var tabPressed=!1,tabShiftPressed=!1,enterPressed=!1,contentEditableSelected=!1,isAddMapSaved=!1;$(".timelineItem:first").hasClass("needsTimeline")||$(".lifeStorySec.lifeStoryMap").addClass("noTimeline");$("ul.timelineList").on("click",".newEditButton",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem"),mediaItems=timelineItem.find(".mediaItem"),timelineItemCurClasses=timelineItem.attr("class"),mediaItemCurClasses=mediaItems.attr("class"),eventId=timelineItem.find(".eventId");closeCallouts();newFactEditModal(window.PersonStory.personData,eventId.val(),!0,"","",!1)}).on("click",".editButton",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem"),mediaItems=timelineItem.find(".mediaItem"),timelineItemCurClasses=timelineItem.attr("class"),mediaItemCurClasses=mediaItems.attr("class"),eventId=timelineItem.find(".eventId"),locationField;closeCallouts();$(".lifeStoryNarrative").addClass("lifeStoryNarrativeDisabled");timelineItem.addClass("timelineItemEditing").data("timelineclasses",timelineItemCurClasses).siblings(".timelineItem").addClass("timelineItemEditingDisabled");timelineItem.hasClass("Media")?timelineItem.addClass("bgDark").find(".storyCuration button").removeAttr("tabindex"):timelineItem.find(".storyCuration button, .targetPerson").addClass("bgDark").removeAttr("tabindex");timelineItem.find(".textEditable").attr({contenteditable:"true",spellcheck:"false"});timelineItem.find(".textEditable[data-placeholder-empty]").each(function(){var $this=$(this);$this.text()===""&&$this.empty()});mediaItems.each(function(){var $this=$(this);$this.attr("data-mediaclasses",mediaItemCurClasses)});timelineItem.focus();eventId.length>0&&(locationField=$("#"+eventId.val()+"LocationField"),locationField.length>0&&storyItemInitTypeAhead(locationField))}).on("click",".timelineItemEditing .closeCuration",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem"),mediaItems=timelineItem.find(".mediaItem"),timelineItemStoredClasses=timelineItem.data("timelineclasses"),mediaItemStoredClasses=mediaItems.data("mediaclasses"),selection=window.getSelection?window.getSelection():document.selection?document.selection:null;($this.hasClass("closeCurationCancel")||window.cancelEdit)&&(closeCallouts(),$(".lifeStoryNarrative").removeClass("lifeStoryNarrativeDisabled"),timelineItem.removeClass("timelineItemEditing bgDark").siblings(".timelineItem").removeClass("timelineItemEditingDisabled"),timelineItem.find(".storyCuration button, .targetPerson").removeClass("bgDark"),timelineItem.find(".storyCuration button").attr("tabindex","-1"),timelineItem.hasClass("HistoricalInsight")||timelineItem.find(".textEditable").removeAttr("contenteditable spellcheck"),!selection||(selection.empty?selection.empty():selection.removeAllRanges()),timelineItem.focus(),timelineItem.attr("class",timelineItemStoredClasses),isAddMapSaved&&(timelineItem.removeClass("timelineItemNoMap").addClass("timelineItemHasMap"),timelineItem.hasClass("timelineItemMapHidden")&&timelineItem.removeClass("timelineItemMapHidden").addClass("timelineItemMapVisible")),isAddMapSaved||timelineItem.hasClass("HistoricalInsight")||(timelineItem.find(".textEditable").each(function(){var $this=$(this);$this.html($this.attr("data-placeholder"))}),timelineItem.find(".editableDateField").val(timelineItem.find(".editableDateField").attr("data-placeholder")),timelineItem.find(".editableLocationField").val(timelineItem.find(".editableLocationField").attr("data-placeholder")),mediaItems.each(function(){var $this=$(this);$this.attr("class",mediaItemStoredClasses)})))}).on("click",".timelineItemEditing .addMediaPhoto",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");closeCallouts()}).on("click",".timelineItemEditing .addMediaMap",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem"),locationField,storyNarrText,assertionid;closeCallouts();locationField=$("#"+timelineItem.find(".eventId").val()+"LocationField");typeof locationField!="undefined"&&locationField.length>0&&locationField.val().length===0?($this.callout({style:"dark",type:"click",classes:"bgDark calloutStyleDark",content:PersonStory.map.addPlaceToSeeMap}),$this.callout("open")):typeof locationField!="undefined"&&locationField.length>0&&locationField.val().length>0&&($this.callout("destroy"),isAddMapSaved=!0,timelineItem.removeClass("timelineItemNoMap").addClass("timelineItemHasMap"),timelineItem.hasClass("timelineItemMapHidden")&&timelineItem.removeClass("timelineItemMapHidden").addClass("timelineItemMapVisible"),storyNarrText=timelineItem.find(".storyNarr").text(),assertionid=timelineItem.find(".eventId").val(),savePersonNarrativeAndEventData(assertionid,!1),timelineItem.find(".narrIsMapOn").val("True"),timelineItem.find(".storyNarr").text(storyNarrText))}).on("click",".timelineItemEditing .toggleMap",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");closeCallouts();timelineItem.hasClass("timelineItemMapHidden")?(personAnalyticsTrackClick("lifeStoryItemShowMap"),timelineItem.removeClass("timelineItemMapHidden").addClass("timelineItemMapVisible")):(personAnalyticsTrackClick("lifeStoryItemHideMap"),timelineItem.removeClass("timelineItemMapVisible").addClass("timelineItemMapHidden"))}).on("click",".timelineItemEditing .toggleMedia",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");closeCallouts();timelineItem.hasClass("timelineItemImageHidden")?(personAnalyticsTrackClick("lifeStoryItemShowMedia"),timelineItem.removeClass("timelineItemImageHidden").addClass("timelineItemImageVisible")):(personAnalyticsTrackClick("lifeStoryItemHideMedia"),timelineItem.removeClass("timelineItemImageVisible").addClass("timelineItemImageHidden"))}).on("click",".timelineItemEditing .closeBtn",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem"),mediaItem=$this.closest(".mediaItem");mediaItem.removeClass("mediaItemVisible").addClass(" mediaItemHidden");mediaItem.siblings().hasClass("mediaItemVisible")||timelineItem.toggleClass("timelineItemNoImage timelineItemHasImage timelineItemImageVisible timelineItemImageHidden")}).on("click",".timelineItemEditing .histEpButtonConfirm",function(){clearNarrativeCache()}).on("click",".timelineItemEditing .hidingEvent",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");closeCallouts();timelineItem.toggleClass("timelineItemHiding").focus()}).on("blur",".timelineItemEditing [contenteditable]",function(){var $this=$(this),contentEditableValue=$this.text();$this.empty().text(contentEditableValue)}).on("blur",".timelineItemEditing .editableLocationField",function(){!window.personScreenType("smart-phone")&&tabPressed&&$(this).attr("disabled","disabled").removeAttr("disabled").closest(".timelineItem").find(".storyCuration button:visible:first").focus()}).on("blur keyup mouseup",".timelineItemEditing [data-placeholder-empty]",function(){var $this=$(this);$this.text()===""&&$this.empty()}).on("blur keyup mouseup",".timelineItemEditing [data-max]",function(e){var $this=$(this),$text=$this.text(),$max=$this.attr("data-max"),limitText=function(ev){if($text.length>=$max){ev.preventDefault();$this.text($text.substr(0,$max-1));var range=document.createRange(),sel=window.getSelection();range.setStart($this.get(0),1);range.collapse(!0);sel.removeAllRanges();sel.addRange(range);$this.focus()}return!0};e.which===17?setTimeout(function(){$text=$this.text();limitText(e)},250):limitText(e)}).on("blur",".timelineItemEditing .mediaList > li:last-child .photoOverlayButton",function(event){var $this=$(this),timelineItem=$this.closest(".timelineItem");if(tabPressed&&(timelineItem.hasClass("Media")||timelineItem.hasClass("HistoricalInsight")))return event.preventDefault(),window.personScreenType("smart-phone")?timelineItem.find(".storyContentFooter .closeCurationCancel").focus():timelineItem.find(".storyCuration .closeCurationCancel").focus(),!1}).on("blur",".timelineItemEditing .curationDiv button:visible:first",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");return!window.personScreenType("smart-phone")&&tabShiftPressed?(timelineItem.hasClass("Media")||timelineItem.hasClass("HistoricalInsight")?timelineItem.find(".mediaList > li:last-child .photoOverlayButton").focus():timelineItem.find(".editableLocationField").focus(),!1):window.personScreenType("smart-phone")&&tabShiftPressed?(timelineItem.find(".storyContentFooter .closeCurationCancel").focus(),!1):void 0}).on("blur",".timelineItemEditing.Media .mediaList > li:first-child .photo",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");!window.personScreenType("smart-phone")&&tabShiftPressed&&timelineItem.find(".storyContentFooter .closeCurationCancel").focus()}).on("blur",".timelineItemEditing .storyContentFooter button:visible:last",function(){var $this=$(this),timelineItem=$this.closest(".timelineItem");if(tabPressed)return timelineItem.hasClass("Media")?timelineItem.find(".photo").focus():timelineItem.hasClass("timelineItemHiding")?timelineItem.find(".storyContentFooter button:visible:first").focus():timelineItem.find(".storyCuration button:visible:first").focus(),!1}).on("blur",".timelineItemHiding .storyContentFooter button:visible:first",function(){if(tabShiftPressed)return $(this).closest(".timelineItem").find(".hidingEventButton").focus(),!1}).on("focus",".timelineItemEditing [contenteditable]",function(){if(contentEditableSelected=!0,tabPressed||tabShiftPressed){var el=this,range=document.createRange(),selection=window.getSelection?window.getSelection():document.selection?document.selection:null;range.selectNodeContents(el);selection.removeAllRanges();selection.addRange(range)}else tabPressed=!1,tabShiftPressed=!1;contentEditableSelected=!1}).on("mousedown",".timelineItemEditing [contenteditable], .timelineItemEditing .editableLocationField",function(){tabPressed=!1;tabShiftPressed=!1;enterPressed=!1;contentEditableSelected===!0&&(contentEditableSelected=!1)}).on("keydown",".timelineItemEditing .ancBtn, .timelineItemEditing .link, .timelineItemEditing [contenteditable], .timelineItemEditing .editableLocationField",function(event){tabPressed=tabShiftPressed=enterPressed=!1;event.which===9&&event.shiftKey&&(tabShiftPressed=!0);event.which!==9||event.shiftKey||(tabPressed=!0);event.which===13&&(enterPressed=!0)}).on("keydown",".timelineItemEditing [contenteditable]",function(){if(contentEditableSelected!==!1){var selection=window.getSelection?window.getSelection():document.selection?document.selection:null;!selection||(selection.empty?selection.empty():selection.removeAllRanges())}})})